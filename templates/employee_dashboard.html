<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alquifiestas - Dashboard Empleado</title>
    <link rel="icon" type="image/svg+xml" href="static/logo-calzada.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-color: #2563EB;
            --primary-light: #60A5FA;
            --primary-dark: #1D4ED8;
            --accent-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --background: #F8FAFC;
            --card-bg: #FFFFFF;
            --border-color: #E5E7EB;
            --sidebar-bg: #FFFFFF;
            --hover-bg: #F1F5F9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: var(--sidebar-bg);
            padding: 2rem;
            box-shadow: 2px 0 25px rgba(0,0,0,0.08);
            border-right: 1px solid var(--border-color);
            position: relative;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
        }

        .logo-container {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .logo-img {
            max-width: 140px;
            height: auto;
            filter: drop-shadow(0 2px 8px rgba(37, 99, 235, 0.15));
        }

        .user-info {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            padding: 1.5rem;
            border-radius: 16px;
            color: white;
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .user-info::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transform: rotate(45deg);
        }

        .user-info h3 {
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .user-info p {
            font-size: 0.9rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .menu-section {
            margin-top: 2rem;
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.25rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            cursor: pointer;
        }

        .menu-link:hover {
            background: var(--hover-bg);
            transform: translateX(8px);
            color: var(--primary-color);
        }

        .menu-link.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            transform: translateX(8px);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .menu-link i {
            width: 24px;
            margin-right: 1rem;
            font-size: 1.2rem;
        }

        /* Main Content */
        .main-content {
            padding: 2.5rem;
            overflow-y: auto;
            background: var(--background);
        }

        .header {
            margin-bottom: 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            position: relative;
            display: inline-block;
        }

        .header h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 60%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), transparent);
            border-radius: 2px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(37, 99, 235, 0.4);
        }

        /* Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2.5rem;
        }

        .card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Tables */
        .table-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: var(--background);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .table td {
            color: var(--text-secondary);
        }

        .table tr:hover {
            background: var(--hover-bg);
        }

        /* Status badges */
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-reservado {
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            color: #92400E;
        }

        .status-confirmado {
            background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
            color: #065F46;
        }

        .status-completado {
            background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
            color: #1E40AF;
        }

        .status-cancelado {
            background: linear-gradient(135deg, #FEE2E2, #FECACA);
            color: #991B1B;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 2% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }


        .calendar-event-item.estado-pendiente_pago {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(96, 165, 250, 0.1));
            border-left-color: #3B82F6;
        }

        .legend-color.pendiente_pago {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(96, 165, 250, 0.2));
            border-left-color: #3B82F6;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--card-bg), #F8FAFC);
            border-radius: 20px 20px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.6rem;
            font-weight: 700;
        }

        .close {
            color: var(--text-secondary);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .close:hover {
            color: var(--text-primary);
            background: var(--hover-bg);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 2rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            border-radius: 0 0 20px 20px;
            background: #fafbfc;
        }

        .btn {
            padding: 1rem 2rem;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-color), #34D399);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #F87171);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-sm {
            padding: 0.75rem 1.25rem;
            font-size: 0.875rem;
        }

       /* Calendar styles mejorados */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .calendar-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .calendar-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .calendar-nav button {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(37, 99, 235, 0.2);
        }

        .calendar-nav button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .calendar-day-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 700;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calendar-day {
            background: var(--card-bg);
            padding: 0.5rem;
            min-height: 120px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            background: var(--hover-bg);
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .calendar-day.other-month {
            opacity: 0.3;
            background: #f8f9fa;
        }

        .calendar-day.today {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(96, 165, 250, 0.1));
            border: 2px solid var(--primary-color);
        }

        .calendar-day.today .day-number {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .calendar-day.has-events {
            border-left: 4px solid var(--primary-color);
        }

        .day-number {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            transition: all 0.3s ease;
        }

        .calendar-events {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            overflow-y: auto;
            max-height: 80px;
            padding-right: 0.25rem;
        }

        .calendar-events::-webkit-scrollbar {
            width: 4px;
        }

        .calendar-events::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }

        .calendar-events::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 2px;
        }

        .calendar-event-item {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(96, 165, 250, 0.1));
            border-left: 3px solid var(--primary-color);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-event-item:hover {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.2), rgba(96, 165, 250, 0.2));
            transform: translateX(2px);
        }

        .calendar-event-item.estado-reservado {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(253, 224, 71, 0.1));
            border-left-color: #F59E0B;
        }

        .calendar-event-item.estado-confirmado {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.1));
            border-left-color: #10B981;
        }

        .calendar-event-item.estado-completado {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(96, 165, 250, 0.1));
            border-left-color: #2563EB;
        }

        .calendar-event-item.estado-cancelado {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(248, 113, 113, 0.1));
            border-left-color: #EF4444;
        }

        .event-time {
            font-weight: 600;
            color: var(--primary-color);
            margin-right: 0.25rem;
        }

        .event-client {
            color: var(--text-secondary);
            font-size: 0.7rem;
        }

        .events-count {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .calendar-legend {
            display: flex;
            gap: 2rem;
            justify-content: center;
            padding: 1.5rem;
            background: var(--card-bg);
            border-radius: 16px;
            margin-top: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border-left: 3px solid;
        }

        .legend-color.reservado {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(253, 224, 71, 0.2));
            border-left-color: #F59E0B;
        }

        .legend-color.confirmado {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.2));
            border-left-color: #10B981;
        }

        .legend-color.completado {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.2), rgba(96, 165, 250, 0.2));
            border-left-color: #2563EB;
        }

        .legend-color.cancelado {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(248, 113, 113, 0.2));
            border-left-color: #EF4444;
        }

        /* Loading state */
        .calendar-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .calendar-day {
                min-height: 80px;
                padding: 0.25rem;
            }

            .calendar-day-header {
                padding: 0.5rem;
                font-size: 0.75rem;
            }

            .day-number {
                font-size: 0.9rem;
                width: 24px;
                height: 24px;
            }

            .calendar-events {
                max-height: 50px;
            }

            .calendar-event-item {
                font-size: 0.65rem;
                padding: 0.15rem 0.35rem;
            }

            .events-count {
                width: 20px;
                height: 20px;
                font-size: 0.65rem;
            }

            .calendar-legend {
                flex-wrap: wrap;
                gap: 1rem;
            }
        }

        /* Stats cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        /* Search and filters */
        .search-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .filter-select {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            background: var(--card-bg);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .main-content {
                padding: 1.5rem;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .search-filters {
                flex-direction: column;
            }

            .search-box {
                min-width: 100%;
            }
        }

        .evento-form-container {
            max-height: 70vh;
            overflow-y: auto;
            padding: 1rem;
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: #fafbfc;
        }

        .form-section h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .section-toggles {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .toggle-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .selection-section {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            background: white;
        }

        .search-bar {
            margin-bottom: 1rem;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .item-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .item-card:hover {
            background: var(--hover-bg);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .item-card.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-dark);
        }

        .item-card h5 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .item-card .price {
            font-size: 1rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .item-card.selected .price {
            color: white;
        }

        .item-card .stock {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .cart-container {
            background: white;
            border-radius: 8px;
            padding: 1rem;
        }

        .cart-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .cart-table th,
        .cart-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .cart-table th {
            background: var(--background);
            font-weight: 600;
            color: var(--text-primary);
        }

        .cart-table td {
            color: var(--text-secondary);
        }

        .cart-total {
            text-align: right;
            padding: 1rem;
            border-top: 2px solid var(--primary-color);
            background: var(--background);
            border-radius: 8px;
        }

        .cart-total h4 {
            margin: 0;
            color: var(--primary-color);
        }

        .qty-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .qty-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .qty-btn:hover {
            background: var(--primary-dark);
        }

        .qty-display {
            background: var(--background);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            width: 40px;
            text-align: center;
            padding: 0.25rem;
            font-weight: 600;
        }

        .required {
            color: var(--danger-color);
        }

        .hidden {
            display: none !important;
        }

        .empty-cart {
            font-style: italic;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .evento-form-container {
                padding: 0.5rem;
            }
            
            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .section-toggles {
                flex-direction: column;
                gap: 1rem;
            }
            
            .cart-table {
                font-size: 0.85rem;
            }
            
            .cart-table th,
            .cart-table td {
                padding: 0.5rem;
            }
        }

        /* Estilos para Reportes Mejorados */
        .reportes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .reporte-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .reporte-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .reporte-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .reporte-card:hover::before {
            transform: scaleX(1);
        }

        .reporte-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .reporte-icon i {
            font-size: 2.5rem;
            color: white;
        }

        .reporte-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .reporte-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .reporte-features {
            margin-bottom: 1.5rem;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .feature-item i {
            color: var(--accent-color);
            font-size: 1rem;
        }

        .btn-reporte {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-reporte:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* Modal de configuración de reportes */
        .config-reporte-section {
            background: #F8FAFC;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .config-reporte-section h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .periodo-rapido {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .periodo-btn {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .periodo-btn:hover {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .periodo-btn.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        .preview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .preview-stat {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .preview-stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .preview-stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .reportes-grid {
                grid-template-columns: 1fr;
            }
            
            .periodo-rapido {
                grid-template-columns: repeat(2, 1fr);
            }
        }

    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-container">
                <img src="static/alquifiestas.png" alt="Logo Alquifiestas" class="logo-img">
            </div>

            <div class="user-info">
                <h3 id="empleado-nombre">Cargando...</h3>
                <p>Empleado</p>
            </div>

            <nav class="menu-section">
                <a href="#" class="menu-link active" data-section="inicio">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
                <a href="#" class="menu-link" data-section="calendario">
                    <i class="fas fa-calendar-alt"></i>
                    Calendario
                </a>
                <a href="#" class="menu-link" data-section="eventos">
                    <i class="fas fa-calendar-plus"></i>
                    Gestión de Eventos
                </a>
                <a href="#" class="menu-link" data-section="cotizaciones">
                    <i class="fas fa-file-invoice-dollar"></i>
                    Cotizaciones
                </a>
                <a href="#" class="menu-link" data-section="articulos">
                    <i class="fas fa-boxes"></i>
                    Inventario
                </a>
                <a href="#" class="menu-link" data-section="clientes">
                    <i class="fas fa-users"></i>
                    Gestión de Clientes
                </a>
                <a href="#" class="menu-link" data-section="reportes">
                    <i class="fas fa-chart-line"></i>
                    Reportes
                </a>
                <a href="#" class="menu-link" data-section="perfil">
                    <i class="fas fa-user"></i>
                    Mi Perfil
                </a>
                <a href="/logout" class="menu-link">
                    <i class="fas fa-sign-out-alt"></i>
                    Cerrar Sesión
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard de Inicio -->
            <section id="inicio" class="section active">
                <div class="header">
                    <h1>Dashboard Empleado</h1>
                    <button class="btn-primary" onclick="openModal('eventoModal')">
                        <i class="fas fa-plus"></i>
                        Nuevo Evento
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-eventos">0</div>
                        <div class="stat-label">Eventos Este Mes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="eventos-hoy">0</div>
                        <div class="stat-label">Eventos Hoy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="cotizaciones-pendientes">0</div>
                        <div class="stat-label">Cotizaciones Pendientes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-clientes">0</div>
                        <div class="stat-label">Clientes Activos</div>
                    </div>
                </div>

                <!-- Recent Events -->
                <div class="cards-grid">
                    <div class="card">
                        <h3><i class="fas fa-calendar-check"></i>Eventos Próximos</h3>
                        <div id="eventos-proximos" class="eventos-list">
                            <p class="text-muted">Cargando eventos...</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-clock"></i>Actividades Pendientes</h3>
                        <div id="actividades-pendientes">
                            <p class="text-muted">No hay actividades pendientes</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Calendario -->
            <section id="calendario" class="section">
                <div class="header">
                    <h1>Calendario de Eventos</h1>
                    <button class="btn-primary" onclick="openModal('eventoModal')">
                        <i class="fas fa-plus"></i>
                        Agendar Evento
                    </button>
                </div>

                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button onclick="cambiarMes(-1)" title="Mes anterior">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h2 id="mes-actual">Cargando...</h2>
                        <button onclick="cambiarMes(1)" title="Mes siguiente">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <button class="btn btn-secondary" onclick="irAHoy()">
                        <i class="fas fa-calendar-day"></i>
                        Hoy
                    </button>
                </div>

                <div id="calendar-loading" class="calendar-loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Cargando eventos...
                </div>

                <div class="calendar-grid" id="calendar-grid">
                    <!-- Calendar will be generated by JavaScript -->
                </div>

                <div class="calendar-legend">
                    <div class="legend-item">
                        <div class="legend-color reservado"></div>
                        <span>Reservado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color confirmado"></div>
                        <span>Confirmado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(96, 165, 250, 0.2)); border-left-color: #3B82F6;"></div>
                        <span>Pendiente Pago</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color cancelado"></div>
                        <span>Cancelado</span>
                    </div>
                </div>
            </section>

            <!-- Sección: Gestión de Eventos -->
            <section id="eventos" class="section">
                <div class="header">
                    <h1>Gestión de Eventos</h1>
                    <button class="btn-primary" onclick="openModal('eventoModal')">
                        <i class="fas fa-plus"></i>
                        Nuevo Evento
                    </button>
                </div>

                <div class="search-filters">
                    <div class="search-box">
                        <input type="text" class="form-control" placeholder="Buscar eventos..." id="search-eventos">
                    </div>
                    <select class="filter-select" id="filter-estado">
                        <option value="">Todos los estados</option>
                        <option value="reservado">Reservado</option>
                        <option value="confirmado">Confirmado</option>
                        <option value="completado">Completado</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Lugar</th>
                                <th>Estado</th>
                                <th>Monto</th>
                                <th>Artículos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="eventos-table-body">
                            <!-- Events will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Cotizaciones -->
            <section id="cotizaciones" class="section">
                <div class="header">
                    <h1>Cotizaciones</h1>
                    <button class="btn-primary" onclick="openModal('cotizacionModal')">
                        <i class="fas fa-plus"></i>
                        Nueva Cotización
                    </button>
                </div>

                <div class="search-filters">
                    <div class="search-box">
                        <input type="text" class="form-control" placeholder="Buscar cotizaciones..." id="search-cotizaciones">
                    </div>
                    <select class="filter-select" id="filter-estado-cotizacion">
                        <option value="">Todos los estados</option>
                        <option value="borrador">Borrador</option>
                        <option value="enviada">Enviada</option>
                        <option value="aprobada">Aprobada</option>
                        <option value="rechazada">Rechazada</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Cliente</th>
                                <th>Fecha Evento</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cotizaciones-table-body">
                            <!-- Cotizaciones will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Artículos -->
            <section id="articulos" class="section">
                <div class="header">
                    <h1>Gestión de Artículos</h1>
                    <button class="btn-primary" onclick="openModal('articuloModal')">
                        <i class="fas fa-plus"></i>
                        Nuevo Artículo
                    </button>
                </div>

                <div class="search-filters">
                    <div class="search-box">
                        <input type="text" class="form-control" placeholder="Buscar artículos..." id="search-articulos">
                    </div>
                    <select class="filter-select" id="filter-categoria">
                        <option value="">Todas las categorías</option>
                        <option value="1">Mobiliario</option>
                        <option value="2">Cristalería</option>
                        <option value="3">Decoración</option>
                        <option value="4">Audio/Video</option>
                        <option value="5">Estructuras</option>
                        <option value="6">Cocina</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>Stock Total</th>
                                <th>Disponible</th>
                                <th>Precio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="articulos-table-body">
                            <!-- Articles will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Gestión de Clientes -->
            <section id="clientes" class="section">
                <div class="header">
                    <h1>Gestión de Clientes</h1>
                    <button class="btn-primary" onclick="openModal('clienteModal')">
                        <i class="fas fa-plus"></i>
                        Nuevo Cliente
                    </button>
                </div>

                <div class="search-filters">
                    <div class="search-box">
                        <input type="text" class="form-control" placeholder="Buscar clientes..." id="search-clientes">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Teléfono</th>
                                <th>Dirección</th>
                                <th>Eventos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientes-table-body">
                            <!-- Clients will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Reportes -->
            <section id="reportes" class="section">
                <div class="header">
                    <h1>Centro de Reportes</h1>
                </div>

                <!-- Estadísticas rápidas de reportes -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-number" id="total-eventos-mes">0</div>
                        <div class="stat-label">Eventos Este Mes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="valor-inventario">Q0.00</div>
                        <div class="stat-label">Valor Total Inventario</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="reportes-problemas-mes">0</div>
                        <div class="stat-label">Problemas Este Mes</div>
                    </div>
                </div>

                <div class="reportes-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 2rem;">
                    <!-- Reporte de Eventos -->
                    <div class="reporte-card">
                        <div class="reporte-icon" style="background: linear-gradient(135deg, #3B82F6, #60A5FA);">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <h3>Reporte de Eventos</h3>
                        <p class="reporte-description">Genera reportes detallados de eventos por período, estado y cliente.</p>
                        
                        <div class="reporte-features">
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Filtrado por fechas</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Filtrado por estado</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Análisis financiero</span>
                            </div>
                        </div>

                        <button class="btn-reporte" onclick="abrirConfiguracionReporte('eventos')" 
                                style="background: linear-gradient(135deg, #3B82F6, #60A5FA);">
                            <i class="fas fa-cog"></i> Configurar Reporte
                        </button>
                    </div>

                    <!-- Reporte de Inventario -->
                    <div class="reporte-card">
                        <div class="reporte-icon" style="background: linear-gradient(135deg, #10B981, #34D399);">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <h3>Reporte de Inventario</h3>
                        <p class="reporte-description">Estado actual del inventario con valorización y análisis de stock.</p>
                        
                        <div class="reporte-features">
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Por categoría</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Alertas de stock bajo</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Valorización total</span>
                            </div>
                        </div>

                        <button class="btn-reporte" onclick="abrirConfiguracionReporte('inventario')"
                                style="background: linear-gradient(135deg, #10B981, #34D399);">
                            <i class="fas fa-cog"></i> Configurar Reporte
                        </button>
                    </div>

                    <!-- Reporte de Problemas -->
                    <div class="reporte-card">
                        <div class="reporte-icon" style="background: linear-gradient(135deg, #EF4444, #F87171);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>Reporte de Problemas</h3>
                        <p class="reporte-description">Análisis de problemas reportados, costos y responsabilidades.</p>
                        
                        <div class="reporte-features">
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Por tipo de problema</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Análisis de costos</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Por responsable</span>
                            </div>
                        </div>

                        <button class="btn-reporte" onclick="abrirConfiguracionReporte('problemas')"
                                style="background: linear-gradient(135deg, #EF4444, #F87171);">
                            <i class="fas fa-cog"></i> Configurar Reporte
                        </button>
                    </div>
                </div>
            </section>

                        <!-- Gestión de Artículos por Evento -->
            <section id="gestion-articulos" class="section">
                <div class="header">
                    <h1>Gestión de Artículos por Evento</h1>
                </div>

                <div class="search-filters">
                    <div class="search-box">
                        <input type="text" class="form-control" placeholder="Buscar eventos..." id="search-gestion-eventos">
                    </div>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Número Evento</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Estado Evento</th>
                                <th>Total Artículos</th>
                                <th>Progreso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="gestion-eventos-table-body">
                            <!-- Eventos will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Mi Perfil -->
            <section id="perfil" class="section">
                <div class="header">
                    <h1>Mi Perfil</h1>
                </div>

                <div class="card">
                    <h3><i class="fas fa-user"></i>Información Personal</h3>
                    <form id="perfil-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nombre Completo</label>
                                <input type="text" class="form-control" id="perfil-nombre" readonly>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" class="form-control" id="perfil-email" readonly>
                            </div>
                            <div class="form-group">
                                <label>Teléfono</label>
                                <input type="text" class="form-control" id="perfil-telefono">
                            </div>
                            <div class="form-group">
                                <label>Cargo</label>
                                <input type="text" class="form-control" id="perfil-cargo" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Dirección</label>
                            <textarea class="form-control" id="perfil-direccion" rows="3"></textarea>
                        </div>
                        <button type="button" class="btn-primary" onclick="actualizarPerfil()">
                            <i class="fas fa-save"></i>
                            Actualizar Perfil
                        </button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Gestión de Artículos del Evento -->
    <div id="gestionArticulosEventoModal" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>inventario - <span id="gestion-evento-numero"></span></h2>
                <span class="close" onclick="closeModal('gestionArticulosEventoModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="evento-info" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div>
                            <strong>Cliente:</strong>
                            <p id="gestion-cliente-nombre">-</p>
                        </div>
                        <div>
                            <strong>Fecha Evento:</strong>
                            <p id="gestion-fecha-evento">-</p>
                        </div>
                        <div>
                            <strong>Estado:</strong>
                            <p id="gestion-estado-evento">-</p>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Artículo</th>
                                <th>Cantidad</th>
                                <th>Stock Actual</th>
                                <th>Estado</th>
                                <th>Fechas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="gestion-articulos-detalle-body">
                            <!-- Articles details will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('gestionArticulosEventoModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Evento -->
    <div id="eventoModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header">
                <h2>Nuevo Evento</h2>
                <span class="close" onclick="closeModal('eventoModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="evento-form-container">
                    <!-- Sección 1: Datos generales -->
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> Datos Generales</h3>
                        <form id="evento-form">
                            <!-- Toggle para cliente nuevo o existente -->
                            <div class="form-group" style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <div style="display: flex; gap: 2rem; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                                        <input type="radio" name="cliente-tipo" value="existente" checked onchange="toggleClienteForm('existente')">
                                        <span>Seleccionar cliente existente</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                                        <input type="radio" name="cliente-tipo" value="nuevo" onchange="toggleClienteForm('nuevo')">
                                        <span>Crear nuevo cliente</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Cliente existente -->
                            <div id="cliente-existente-section">
                                <div class="form-group">
                                    <label>Cliente <span class="required">*</span></label>
                                    <select class="form-control" id="evento-cliente">
                                        <option value="">Seleccionar cliente...</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Nuevo cliente -->
                            <div id="cliente-nuevo-section" class="hidden">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Nombre del Cliente <span class="required">*</span></label>
                                        <input type="text" class="form-control" id="nuevo-cliente-nombre" placeholder="Nombre completo">
                                    </div>
                                    <div class="form-group">
                                        <label>Teléfono</label>
                                        <input type="text" class="form-control" id="nuevo-cliente-telefono" placeholder="Ej: 1234-5678">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Dirección</label>
                                    <textarea class="form-control" id="nuevo-cliente-direccion" rows="2" placeholder="Dirección del cliente"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Notas sobre el cliente</label>
                                    <textarea class="form-control" id="nuevo-cliente-notas" rows="2" placeholder="Información adicional"></textarea>
                                </div>
                            </div>

                            <!-- Resto del formulario de evento -->
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Fecha del Evento <span class="required">*</span></label>
                                    <input type="date" class="form-control" id="evento-fecha" required>
                                </div>
                                <div class="form-group">
                                    <label>Hora Inicio</label>
                                    <input type="time" class="form-control" id="evento-hora-inicio">
                                </div>
                                <div class="form-group">
                                    <label>Hora Fin</label>
                                    <input type="time" class="form-control" id="evento-hora-fin">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Lugar del Evento</label>
                                <input type="text" class="form-control" id="evento-lugar" placeholder="Dirección del evento">
                            </div>
                            <div class="form-group">
                                <label>Número de Invitados</label>
                                <input type="number" class="form-control" id="evento-invitados" min="1" placeholder="Ej: 80">
                            </div>
                            <div class="form-group">
                                <label>Notas</label>
                                <textarea class="form-control" id="evento-notas" rows="3" placeholder="Notas adicionales..."></textarea>
                            </div>
                        </form>
                    </div>

                    <!-- Sección 2: Artículos y Servicios -->
                    <div class="form-section">
                        <h3><i class="fas fa-boxes"></i> Artículos y Servicios</h3>
                        
                        <!-- Checkboxes para mostrar secciones -->
                        <div class="section-toggles">
                            <div class="toggle-item">
                                <input type="checkbox" id="toggleArticulos" onchange="toggleEventoSection('articulos-section')">
                                <label for="toggleArticulos">Incluir Artículos</label>
                            </div>
                            <div class="toggle-item">
                                <input type="checkbox" id="toggleServicios" onchange="toggleEventoSection('servicios-section')">
                                <label for="toggleServicios">Incluir Servicios</label>
                            </div>
                        </div>

                        <!-- Sección Artículos -->
                        <div id="articulos-section" class="selection-section hidden">
                            <h4>Seleccionar Artículos</h4>
                            <div class="search-bar">
                                <input type="text" class="form-control" id="search-articulos-evento" placeholder="Buscar artículos...">
                            </div>
                            <div class="items-grid" id="articulos-grid">
                                <!-- Artículos se cargarán aquí -->
                            </div>
                        </div>

                        <!-- Sección Servicios -->
                        <div id="servicios-section" class="selection-section hidden">
                            <h4>Seleccionar Servicios</h4>
                            <div class="items-grid" id="servicios-grid">
                                <!-- Servicios se cargarán aquí -->
                            </div>
                        </div>
                    </div>

                    <!-- Sección 3: Carrito/Resumen -->
                    <div class="form-section">
                        <h3><i class="fas fa-shopping-cart"></i> Resumen del Evento</h3>
                        <div class="cart-container">
                            <table class="cart-table" id="evento-cart">
                                <thead>
                                    <tr>
                                        <th>Concepto</th>
                                        <th>Precio Unitario</th>
                                        <th>Cantidad</th>
                                        <th>Subtotal</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="cart-body">
                                    <tr class="empty-cart">
                                        <td colspan="5" class="text-center text-muted">No hay elementos en el carrito</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="cart-total">
                                <h4>Total: Q<span id="cart-total">0.00</span></h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('eventoModal')">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="guardarEventoCompleto()">
                            <i class="fas fa-save"></i>
                            Guardar Evento
            </button>
            </div>
        </div>
    </div>


    <!-- Modal Nuevo Cliente -->
    <div id="clienteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuevo Cliente</h2>
                <span class="close" onclick="closeModal('clienteModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="cliente-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre Completo</label>
                            <input type="text" class="form-control" id="cliente-nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono</label>
                            <input type="text" class="form-control" id="cliente-telefono">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Dirección</label>
                        <textarea class="form-control" id="cliente-direccion" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea class="form-control" id="cliente-notas" rows="3" placeholder="Notas adicionales sobre el cliente..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('clienteModal')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCliente()">
                    <i class="fas fa-save"></i>
                    Guardar Cliente
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Cliente -->
    <div id="editarClienteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Cliente</h2>
                <span class="close" onclick="closeModal('editarClienteModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editar-cliente-form">
                    <input type="hidden" id="edit-cliente-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre Completo</label>
                            <input type="text" class="form-control" id="edit-cliente-nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Teléfono</label>
                            <input type="text" class="form-control" id="edit-cliente-telefono">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Dirección</label>
                        <textarea class="form-control" id="edit-cliente-direccion" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea class="form-control" id="edit-cliente-notas" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editarClienteModal')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="actualizarCliente()">
                    <i class="fas fa-save"></i>
                    Actualizar Cliente
                </button>
            </div>
        </div>
    </div>

        <!-- Modal Nueva Cotización Completa -->
    <div id="cotizacionModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header">
                <h2>Nueva Cotización</h2>
                <span class="close" onclick="closeModal('cotizacionModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="evento-form-container">
                    <!-- Sección 1: Datos generales -->
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> Datos Generales</h3>
                        <form id="cotizacion-form-completa">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Cliente <small>(Opcional - puede definirse después)</small></label>
                                    <select class="form-control" id="cotizacion-cliente">
                                        <option value="">Sin cliente definido</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Fecha del Evento</label>
                                    <input type="date" class="form-control" id="cotizacion-fecha">
                                </div>
                                <div class="form-group">
                                    <label>Hora Inicio</label>
                                    <input type="time" class="form-control" id="cotizacion-hora-inicio">
                                </div>
                                <div class="form-group">
                                    <label>Hora Fin</label>
                                    <input type="time" class="form-control" id="cotizacion-hora-fin">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Lugar del Evento</label>
                                <input type="text" class="form-control" id="cotizacion-lugar" placeholder="Dirección del evento">
                            </div>
                            <div class="form-group">
                                <label>Número de Invitados</label>
                                <input type="number" class="form-control" id="cotizacion-invitados" min="1" placeholder="Ej: 80">
                            </div>
                            <div class="form-group">
                                <label>Notas / Requerimientos Especiales</label>
                                <textarea class="form-control" id="cotizacion-notas" rows="3" placeholder="Detalles adicionales..."></textarea>
                            </div>
                        </form>
                    </div>

                    <!-- Sección 2: Artículos y Servicios -->
                    <div class="form-section">
                        <h3><i class="fas fa-boxes"></i> Artículos y Servicios</h3>
                        
                        <!-- Checkboxes para mostrar secciones -->
                        <div class="section-toggles">
                            <div class="toggle-item">
                                <input type="checkbox" id="toggleArticulosCot" onchange="toggleCotizacionSection('articulos-section-cot')">
                                <label for="toggleArticulosCot">Incluir Artículos</label>
                            </div>
                            <div class="toggle-item">
                                <input type="checkbox" id="toggleServiciosCot" onchange="toggleCotizacionSection('servicios-section-cot')">
                                <label for="toggleServiciosCot">Incluir Servicios</label>
                            </div>
                        </div>

                        <!-- Sección Artículos -->
                        <div id="articulos-section-cot" class="selection-section hidden">
                            <h4>Seleccionar Artículos</h4>
                            <div class="search-bar">
                                <input type="text" class="form-control" id="search-articulos-cot" placeholder="Buscar artículos...">
                            </div>
                            <div class="items-grid" id="articulos-grid-cot">
                                <!-- Artículos se cargarán aquí -->
                            </div>
                        </div>

                        <!-- Sección Servicios -->
                        <div id="servicios-section-cot" class="selection-section hidden">
                            <h4>Seleccionar Servicios</h4>
                            <div class="items-grid" id="servicios-grid-cot">
                                <!-- Servicios se cargarán aquí -->
                            </div>
                        </div>
                    </div>

                    <!-- Sección 3: Carrito/Resumen -->
                    <div class="form-section">
                        <h3><i class="fas fa-shopping-cart"></i> Resumen de la Cotización</h3>
                        <div class="cart-container">
                            <table class="cart-table" id="cotizacion-cart">
                                <thead>
                                    <tr>
                                        <th>Concepto</th>
                                        <th>Precio Unitario</th>
                                        <th>Cantidad</th>
                                        <th>Subtotal</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="cart-body-cot">
                                    <tr class="empty-cart">
                                        <td colspan="5" class="text-center text-muted">No hay elementos en la cotización</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="cart-total">
                                <h4>Total: Q<span id="cart-total-cot">0.00</span></h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('cotizacionModal')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCotizacionCompleta()">
                    <i class="fas fa-save"></i>
                    Guardar Cotización
                </button>
            </div>
        </div>
    </div>


    <!-- Modal Nuevo Artículo -->
    <div id="articuloModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nuevo Artículo</h2>
                <span class="close" onclick="closeModal('articuloModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="articulo-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Código</label>
                            <input type="text" class="form-control" id="articulo-codigo" required>
                        </div>
                        <div class="form-group">
                            <label>Nombre del Artículo</label>
                            <input type="text" class="form-control" id="articulo-nombre" required>
                        </div>
                        <div class="form-group">
                            <label>Categoría</label>
                            <select class="form-control" id="articulo-categoria" required>
                                <option value="">Seleccionar categoría...</option>
                                <option value="1">Mobiliario</option>
                                <option value="2">Cristalería</option>
                                <option value="3">Decoración</option>
                                <option value="4">Audio/Video</option>
                                <option value="5">Estructuras</option>
                                <option value="6">Cocina</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Precio Unitario</label>
                            <input type="number" class="form-control" id="articulo-precio" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Cantidad Total</label>
                            <input type="number" class="form-control" id="articulo-cantidad" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Costo de Reposición</label>
                            <input type="number" class="form-control" id="articulo-costo" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Descripción</label>
                        <textarea class="form-control" id="articulo-descripcion" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('articuloModal')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarArticulo()">
                    <i class="fas fa-save"></i>
                    Guardar Artículo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Editar Evento -->
    <div id="editarEventoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Evento</h2>
                <span class="close" onclick="closeModal('editarEventoModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editar-evento-form">
                    <input type="hidden" id="edit-evento-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Cliente</label>
                            <select class="form-control" id="edit-evento-cliente" required>
                                <option value="">Seleccionar cliente...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha del Evento</label>
                            <input type="date" class="form-control" id="edit-evento-fecha" required>
                        </div>
                        <div class="form-group">
                            <label>Hora Inicio</label>
                            <input type="time" class="form-control" id="edit-evento-hora-inicio">
                        </div>
                        <div class="form-group">
                            <label>Hora Fin</label>
                            <input type="time" class="form-control" id="edit-evento-hora-fin">
                        </div>
                        <div class="form-group">
                            <label>Estado</label>
                            <select class="form-control" id="edit-evento-estado">
                                <option value="reservado">Reservado</option>
                                <option value="confirmado">Confirmado</option>
                                <option value="en_preparacion">En Preparación</option>
                                <option value="pendiente_entrega">Pendiente Entrega</option>
                                <option value="entregado">Entregado</option>
                                <option value="completado">Completado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Número de Invitados</label>
                            <input type="number" class="form-control" id="edit-evento-invitados" min="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Lugar del Evento</label>
                        <input type="text" class="form-control" id="edit-evento-lugar">
                    </div>
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea class="form-control" id="edit-evento-notas" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editarEventoModal')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="actualizarEvento()">
                    <i class="fas fa-save"></i>
                    Actualizar Evento
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Detalle Evento -->
    <div id="detalleEventoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalle del Evento</h2>
                <span class="close" onclick="closeModal('detalleEventoModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="detalle-evento-content">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('detalleEventoModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Cotización -->
    <div id="detalleCotizacionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalle de Cotización</h2>
                <span class="close" onclick="closeModal('detalleCotizacionModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="detalle-cotizacion-content">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('detalleCotizacionModal')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Convertir Cotización a Evento -->
    <div id="convertirEventoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Convertir a Evento</h2>
                <span class="close" onclick="closeModal('convertirEventoModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="convertir-evento-form">
                    <input type="hidden" id="convertir-cotizacion-id">
                    <div class="form-group">
                        <label>¿Confirmar conversión de cotización a evento?</label>
                        <p class="text-muted">Esta acción creará un nuevo evento basado en los datos de la cotización.</p>
                    </div>
                    <div id="convertir-evento-preview">
                        <!-- Preview content will be loaded -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('convertirEventoModal')">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="confirmarConversion()">
                    <i class="fas fa-check"></i>
                    Convertir a Evento
                </button>
            </div>
        </div>
    </div>


    <!-- Modal Reportar Problemas Múltiples -->
    <div id="reportarProblemasModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <div class="modal-header">
                <h2>Reportar Problemas del Evento</h2>
                <span class="close" onclick="closeModal('reportarProblemasModal')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="problemas-evento-id">
                
                <div class="form-section">
                    <h3><i class="fas fa-exclamation-triangle"></i> Artículos con Problemas</h3>
                    <p class="text-muted">Complete la información para cada artículo que presenta problemas</p>
                </div>

                <div id="articulos-problemas-container" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Se llenará dinámicamente con JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('reportarProblemasModal')">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="guardarProblemasMultiples()">
                    <i class="fas fa-save"></i>
                    Guardar Todos los Reportes
                </button>
            </div>
        </div>
    </div>


    <!-- Modal Configuración Reporte de Eventos -->
    <div id="configEventosModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-alt"></i> Configurar Reporte de Eventos</h2>
                <span class="close" onclick="closeModal('configEventosModal')">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Período -->
                <div class="config-reporte-section">
                    <h4><i class="fas fa-calendar"></i> Seleccionar Período</h4>
                    
                    <div class="periodo-rapido">
                        <button class="periodo-btn" onclick="setPeriodoRapido('hoy', 'eventos')">Hoy</button>
                        <button class="periodo-btn" onclick="setPeriodoRapido('semana', 'eventos')">Esta Semana</button>
                        <button class="periodo-btn" onclick="setPeriodoRapido('mes', 'eventos')">Este Mes</button>
                        <button class="periodo-btn" onclick="setPeriodoRapido('trimestre', 'eventos')">Trimestre</button>
                        <button class="periodo-btn" onclick="setPeriodoRapido('anio', 'eventos')">Este Año</button>
                        <button class="periodo-btn active" onclick="setPeriodoRapido('personalizado', 'eventos')">Personalizado</button>
                    </div>

                    <div class="form-grid" id="fechas-personalizadas-eventos">
                        <div class="form-group">
                            <label>Fecha Inicio</label>
                            <input type="date" class="form-control" id="config-eventos-fecha-inicio">
                        </div>
                        <div class="form-group">
                            <label>Fecha Fin</label>
                            <input type="date" class="form-control" id="config-eventos-fecha-fin">
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="config-reporte-section">
                    <h4><i class="fas fa-filter"></i> Filtros Adicionales</h4>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Estado del Evento</label>
                            <select class="form-control" id="config-eventos-estado">
                                <option value="">Todos los estados</option>
                                <option value="reservado">Reservado</option>
                                <option value="confirmado">Confirmado</option>
                                <option value="pendiente_pago">Pendiente de Pago</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cliente (Opcional)</label>
                            <select class="form-control" id="config-eventos-cliente">
                                <option value="">Todos los clientes</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="config-eventos-detallado">
                            <span>Incluir desglose detallado de artículos y servicios</span>
                        </label>
                    </div>
                </div>

                <!-- Previsualización -->
                <div class="config-reporte-section">
                    <h4><i class="fas fa-eye"></i> Vista Previa</h4>
                    <div class="preview-stats" id="preview-eventos-stats">
                        <div class="preview-stat">
                            <div class="preview-stat-number">-</div>
                            <div class="preview-stat-label">Total Eventos</div>
                        </div>
                        <div class="preview-stat">
                            <div class="preview-stat-number">-</div>
                            <div class="preview-stat-label">Ingresos</div>
                        </div>
                        <div class="preview-stat">
                            <div class="preview-stat-number">-</div>
                            <div class="preview-stat-label">Pagado</div>
                        </div>
                        <div class="preview-stat">
                            <div class="preview-stat-number">-</div>
                            <div class="preview-stat-label">Pendiente</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('configEventosModal')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="generarReporteEventosConfig()">
                    <i class="fas fa-file-pdf"></i> Generar PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Configuración Reporte de Inventario -->
    <div id="configInventarioModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2><i class="fas fa-boxes"></i> Configurar Reporte de Inventario</h2>
                <span class="close" onclick="closeModal('configInventarioModal')">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Opciones -->
                <div class="config-reporte-section">
                    <h4><i class="fas fa-sliders-h"></i> Opciones del Reporte</h4>
                    
                    <div class="form-group">
                        <label>Categoría</label>
                        <select class="form-control" id="config-inventario-categoria">
                            <option value="">Todas las categorías</option>
                            <option value="1">Mobiliario</option>
                            <option value="2">Cristalería</option>
                            <option value="3">Decoración</option>
                            <option value="4">Audio/Video</option>
                            <option value="5">Estructuras</option>
                            <option value="6">Cocina</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="config-inventario-stock-bajo" checked>
                            <span>Destacar artículos con stock bajo (menos de 10)</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="config-inventario-valorizacion" checked>
                            <span>Incluir valorización del inventario</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="config-inventario-daniados">
                            <span>Mostrar artículos dañados</span>
                        </label>
                    </div>
                </div>

                <!-- Previsualización -->
                <div class="config-reporte-section">
                    <h4><i class="fas fa-eye"></i> Vista Previa</h4>
                    <div class="preview-stats" id="preview-inventario-stats">
                        <div class="preview-stat">
                            <div class="preview-stat-number">-</div>
                            <div class="preview-stat-label">Total Artículos</div>
                        </div>
                        <div class="preview-stat">
                            <div class="preview-stat-number">-</div>
                            <div class="preview-stat-label">Stock Total</div>
                        </div>
                        <div class="preview-stat">
                            <div class="preview-stat-number">-</div>
                            <div class="preview-stat-label">Disponibles</div>
                        </div>
                        <div class="preview-stat">
                            <div class="preview-stat-number">-</div>
                            <div class="preview-stat-label">Valor Total</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('configInventarioModal')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="generarReporteInventarioConfig()">
                    <i class="fas fa-file-pdf"></i> Generar PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Configuración Reporte de Problemas -->
    <div id="configProblemasModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Configurar Reporte de Problemas</h2>
                <span class="close" onclick="closeModal('configProblemasModal')">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Período -->
                <div class="config-reporte-section">
                    <h4><i class="fas fa-calendar"></i> Seleccionar Período</h4>
                    
                    <div class="periodo-rapido">
                        <button class="periodo-btn" onclick="setPeriodoRapido('hoy', 'problemas')">Hoy</button>
                        <button class="periodo-btn" onclick="setPeriodoRapido('semana', 'problemas')">Esta Semana</button>
                        <button class="periodo-btn active" onclick="setPeriodoRapido('mes', 'problemas')">Este Mes</button>
                        <button class="periodo-btn" onclick="setPeriodoRapido('trimestre', 'problemas')">Trimestre</button>
                        <button class="periodo-btn" onclick="setPeriodoRapido('anio', 'problemas')">Este Año</button>
                        <button class="periodo-btn" onclick="setPeriodoRapido('personalizado', 'problemas')">Personalizado</button>
                    </div>

                    <div class="form-grid" id="fechas-personalizadas-problemas" style="display: none;">
                        <div class="form-group">
                            <label>Fecha Inicio</label>
                            <input type="date" class="form-control" id="config-problemas-fecha-inicio">
                        </div>
                        <div class="form-group">
                            <label>Fecha Fin</label>
                            <input type="date" class="form-control" id="config-problemas-fecha-fin">
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="config-reporte-section">
                    <h4><i class="fas fa-filter"></i> Filtros</h4>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tipo de Problema</label>
                            <select class="form-control" id="config-problemas-tipo">
                                <option value="">Todos los tipos</option>
                                <option value="roto">Roto</option>
                                <option value="perdido">Perdido</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Responsable</label>
                            <select class="form-control" id="config-problemas-responsable">
                                <option value="">Todos</option>
                                <option value="Cliente">Cliente</option>
                                <option value="Empresa">Empresa</option>
                                <option value="Tercero">Tercero</option>
                                <option value="Desconocido">Desconocido</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="config-problemas-graficos" checked>
                            <span>Incluir análisis gráfico de costos</span>
                        </label>
                    </div>
                </div>

                <!-- Previsualización -->
                <div class="config-reporte-section">
                    <h4><i class="fas fa-eye"></i> Vista Previa</h4>
                    <div class="preview-stats" id="preview-problemas-stats">
                        <div class="preview-stat">
                            <div class="preview-stat-number">-</div>
                            <div class="preview-stat-label">Total Problemas</div>
                        </div>
                        <div class="preview-stat">
                            <div class="preview-stat-number">-</div>
                            <div class="preview-stat-label">Costo Total</div>
                        </div>
                        <div class="preview-stat">
                            <div class="preview-stat-number">-</div>
                            <div class="preview-stat-label">Rotos</div>
                        </div>
                        <div class="preview-stat">
                            <div class="preview-stat-number">-</div>
                            <div class="preview-stat-label">Perdidos</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('configProblemasModal')">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="generarReporteProblemasConfig()">
                    <i class="fas fa-file-pdf"></i> Generar PDF
                </button>
            </div>
        </div>
    </div>


    <script>
    // ===============================================
    // VARIABLES GLOBALES
    // ===============================================
    let currentDate = new Date();
    let eventosDelMes = [];
    let selectedDate = null;
    let clientes = [];
    let eventos = [];
    let articulos = [];
    let eventoCart = [];
    let articulosDisponibles = [];
    let serviciosDisponibles = [];
    let eventosGestion = [];
    let articulosGestionActual = [];
    let eventoGestionActual = null;
    let cotizacionCart = [];
    let cotizacionActualId = null;

    // ===============================================
    // INICIALIZACIÓN
    // ===============================================
    document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
        setupMenuNavigation();
        loadDashboardData();
    });

    function initializeDashboard() {
        const nombreEmpleado = "{{ user.name if user else 'Empleado' }}";
        document.getElementById('empleado-nombre').textContent = nombreEmpleado;
        generateCalendar();
    }

    // ===============================================
    // NAVEGACIÓN Y UI
    // ===============================================
    function setupMenuNavigation() {
        const menuLinks = document.querySelectorAll('.menu-link[data-section]');
        
        menuLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const sectionId = this.getAttribute('data-section');
                
                menuLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                showSection(sectionId);
                loadSectionData(sectionId);
            });
        });
    }

    function showSection(sectionId) {
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => section.classList.remove('active'));
        
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active');
        }
    }

    function loadSectionData(sectionId) {
        switch(sectionId) {
            case 'inicio':
                loadDashboardData();
                break;
            case 'eventos':
                loadEventos();
                break;
            case 'cotizaciones':
                loadCotizaciones();
                break;
            case 'articulos':
                loadArticulos();
                break;
            case 'clientes':
                loadClientes();
                break;
            case 'gestion-articulos':
                loadEventosConArticulos();
                break;
            case 'perfil':
                loadPerfilData();
                break;
        }
    }

    // ===============================================
    // DASHBOARD - DATOS PRINCIPALES
    // ===============================================
    async function loadDashboardData() {
        try {
            const stats = await fetch('/api/dashboard/stats').then(r => r.json());
            if (stats.success) {
                document.getElementById('total-eventos').textContent = stats.total_eventos || 0;
                document.getElementById('eventos-hoy').textContent = stats.eventos_hoy || 0;
                document.getElementById('cotizaciones-pendientes').textContent = stats.cotizaciones_pendientes || 0;
                document.getElementById('total-clientes').textContent = stats.total_clientes || 0;
            }
            loadEventosProximos();
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }

    async function loadEventosProximos() {
        try {
            const response = await fetch('/api/eventos/proximos');
            const data = await response.json();
            
            const container = document.getElementById('eventos-proximos');
            
            if (data.success && data.eventos.length > 0) {
                container.innerHTML = data.eventos.map(evento => `
                    <div class="evento-item">
                        <div class="evento-header">
                            <strong>${evento.cliente_nombre}</strong>
                            <span class="status-badge status-${evento.estado}">${evento.estado}</span>
                        </div>
                        <div class="evento-details">
                            <p><i class="fas fa-calendar"></i> ${formatDate(evento.fecha_evento)}</p>
                            <p><i class="fas fa-clock"></i> ${evento.hora_inicio} - ${evento.hora_fin}</p>
                            <p><i class="fas fa-map-marker-alt"></i> ${evento.lugar_evento}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-muted">No hay eventos próximos</p>';
            }
        } catch (error) {
            console.error('Error loading eventos próximos:', error);
            document.getElementById('eventos-proximos').innerHTML = '<p class="text-muted">Error cargando eventos</p>';
        }
    }

    // ===============================================
    // GESTIÓN DE CLIENTES
    // ===============================================
    async function loadClientes() {
        try {
            const response = await fetch('/api/clientes');
            const data = await response.json();
            
            if (data.success) {
                clientes = data.clientes;
                renderClientesTable();
                populateClienteSelect();
            }
        } catch (error) {
            console.error('Error loading clientes:', error);
            Swal.fire('Error', 'Error cargando clientes', 'error');
        }
    }

    function renderClientesTable(clientesList = clientes) {
        const tbody = document.getElementById('clientes-table-body');
        
        if (clientesList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay clientes registrados</td></tr>';
            return;
        }

        tbody.innerHTML = clientesList.map(cliente => `
            <tr>
                <td>${cliente.nombre}</td>
                <td>${cliente.telefono || '-'}</td>
                <td>${cliente.direccion || '-'}</td>
                <td>0</td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="editarCliente(${cliente.id_cliente})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="eliminarCliente(${cliente.id_cliente})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function populateClienteSelect() {
        const selects = ['evento-cliente', 'cotizacion-cliente', 'edit-evento-cliente'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = '<option value="">Seleccionar cliente...</option>' +
                    clientes.map(cliente => `<option value="${cliente.id_cliente}">${cliente.nombre}</option>`).join('');
            }
        });
    }

    async function guardarCliente() {
        const nombre = document.getElementById('cliente-nombre').value;
        const telefono = document.getElementById('cliente-telefono').value;
        const direccion = document.getElementById('cliente-direccion').value;
        const notas = document.getElementById('cliente-notas').value;
        
        if (!nombre.trim()) {
            Swal.fire('Error', 'El nombre es requerido', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/clientes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, telefono, direccion, notas })
            });
            
            const data = await response.json();
            
            if (data.success) {
                Swal.fire('Éxito', 'Cliente guardado correctamente', 'success');
                closeModal('clienteModal');
                loadClientes();
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error('Error saving cliente:', error);
            Swal.fire('Error', 'Error al guardar cliente', 'error');
        }
    }

    async function editarCliente(id) {
        try {
            const cliente = clientes.find(c => c.id_cliente === id);
            if (!cliente) {
                Swal.fire('Error', 'Cliente no encontrado', 'error');
                return;
            }

            document.getElementById('edit-cliente-id').value = cliente.id_cliente;
            document.getElementById('edit-cliente-nombre').value = cliente.nombre;
            document.getElementById('edit-cliente-telefono').value = cliente.telefono || '';
            document.getElementById('edit-cliente-direccion').value = cliente.direccion || '';
            document.getElementById('edit-cliente-notas').value = cliente.notas || '';

            openModal('editarClienteModal');
        } catch (error) {
            console.error('Error loading cliente for edit:', error);
            Swal.fire('Error', 'Error cargando datos del cliente', 'error');
        }
    }

    async function actualizarCliente() {
        const id = document.getElementById('edit-cliente-id').value;
        const nombre = document.getElementById('edit-cliente-nombre').value;
        const telefono = document.getElementById('edit-cliente-telefono').value;
        const direccion = document.getElementById('edit-cliente-direccion').value;
        const notas = document.getElementById('edit-cliente-notas').value;

        if (!nombre.trim()) {
            Swal.fire('Error', 'El nombre es requerido', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/clientes/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, telefono, direccion, notas })
            });

            const data = await response.json();

            if (data.success) {
                Swal.fire('Éxito', 'Cliente actualizado correctamente', 'success');
                closeModal('editarClienteModal');
                loadClientes();
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error('Error updating cliente:', error);
            Swal.fire('Error', 'Error al actualizar cliente', 'error');
        }
    }

    async function eliminarCliente(id) {
        const result = await Swal.fire({
            title: '¿Estás seguro?',
            text: 'Esta acción no se puede deshacer',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            try {
                const response = await fetch(`/api/clientes/${id}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    Swal.fire('Eliminado', 'Cliente eliminado correctamente', 'success');
                    loadClientes();
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting cliente:', error);
                Swal.fire('Error', 'Error al eliminar cliente', 'error');
            }
        }
    }

    function toggleClienteForm(tipo) {
        const existenteSection = document.getElementById('cliente-existente-section');
        const nuevoSection = document.getElementById('cliente-nuevo-section');
        
        if (tipo === 'existente') {
            existenteSection.classList.remove('hidden');
            nuevoSection.classList.add('hidden');
            
            document.getElementById('nuevo-cliente-nombre').value = '';
            document.getElementById('nuevo-cliente-telefono').value = '';
            document.getElementById('nuevo-cliente-direccion').value = '';
            document.getElementById('nuevo-cliente-notas').value = '';
        } else {
            existenteSection.classList.add('hidden');
            nuevoSection.classList.remove('hidden');
            
            document.getElementById('evento-cliente').value = '';
        }
    }

    // ===============================================
    // GESTIÓN DE EVENTOS
    // ===============================================
    async function loadEventos() {
        try {
            const response = await fetch('/api/eventos');
            const data = await response.json();
            
            if (data.success) {
                eventos = data.eventos;
                renderEventosTable();
            }
        } catch (error) {
            console.error('Error loading eventos:', error);
        }
    }


    function renderEventosTable(eventosList = eventos) {
        const tbody = document.getElementById('eventos-table-body');
        
        if (eventosList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay eventos registrados</td></tr>';
            return;
        }

        tbody.innerHTML = eventosList.map(evento => {
            if (!evento.id_evento) {
                console.warn('⚠️ Evento sin ID:', evento);
            }
            
            const estadoColor = getEstadoBackgroundColor(evento.estado);
            
            return `
                <tr>
                    <td>${evento.cliente_nombre}</td>
                    <td>${formatDate(evento.fecha_evento)}</td>
                    <td>${evento.lugar_evento || '-'}</td>
                    <td>
                        <select class="form-control" 
                                style="padding: 0.5rem; font-size: 0.875rem; background: ${estadoColor}; font-weight: 600; border: 2px solid rgba(0,0,0,0.1); min-width: 150px;" 
                                onchange="cambiarEstadoEvento(${evento.id_evento}, this.value)">
                            <option value="reservado" ${evento.estado === 'reservado' ? 'selected' : ''}>Reservado</option>
                            <option value="confirmado" ${evento.estado === 'confirmado' ? 'selected' : ''}>Confirmado</option>
                            <option value="pendiente_pago" ${evento.estado === 'pendiente_pago' ? 'selected' : ''}>Pendiente de Pago</option>
                            <option value="cancelado" ${evento.estado === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                        </select>
                    </td>
                    <td>Q${parseFloat(evento.monto_total || 0).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-success btn-sm" 
                                onclick="abrirGestionArticulosEvento(${evento.id_evento})" 
                                title="Gestionar Artículos"
                                data-evento-id="${evento.id_evento}">
                            <i class="fas fa-boxes"></i> Artículos
                        </button>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="verEvento(${evento.id_evento})" title="Ver Detalle">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="editarEvento(${evento.id_evento})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarEvento(${evento.id_evento})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }


    async function eliminarEvento(id) {
        // Primero verificar si el evento tiene artículos o pagos asociados
        try {
            const checkResponse = await fetch(`/api/eventos/${id}/puede-eliminar`);
            const checkData = await checkResponse.json();
            
            let warningMessage = '¿Estás seguro de eliminar este evento?';
            if (checkData.tiene_articulos || checkData.tiene_pagos) {
                warningMessage = `<div style="text-align: left;">
                    <p><strong>⚠️ Advertencia:</strong></p>
                    <ul style="margin-top: 0.5rem;">
                        ${checkData.tiene_articulos ? '<li>Este evento tiene artículos asociados</li>' : ''}
                        ${checkData.tiene_pagos ? '<li>Este evento tiene pagos registrados</li>' : ''}
                    </ul>
                    <p style="margin-top: 1rem;">¿Deseas continuar con la eliminación?</p>
                </div>`;
            }
            
            const result = await Swal.fire({
                title: 'Confirmar Eliminación',
                html: warningMessage,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#EF4444'
            });

            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Eliminando...',
                    text: 'Por favor espera',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                const response = await fetch(`/api/eventos/${id}`, { 
                    method: 'DELETE' 
                });
                const data = await response.json();
                
                if (data.success) {
                    Swal.fire('Eliminado', 'Evento eliminado correctamente', 'success');
                    await loadEventos();
                    await loadDashboardData();
                    
                    // Actualizar calendario si está visible
                    const calendarioSection = document.getElementById('calendario');
                    if (calendarioSection && calendarioSection.classList.contains('active')) {
                        await generateCalendar();
                    }
                } else {
                    Swal.fire('Error', data.message || 'No se pudo eliminar el evento', 'error');
                }
            }
        } catch (error) {
            console.error('Error eliminando evento:', error);
            Swal.fire('Error', 'Error al eliminar el evento', 'error');
        }
    }

    document.getElementById('search-eventos')?.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const filteredEventos = eventos.filter(evento => 
            (evento.cliente_nombre && evento.cliente_nombre.toLowerCase().includes(searchTerm)) ||
            (evento.lugar_evento && evento.lugar_evento.toLowerCase().includes(searchTerm)) ||
            (evento.numero_evento && evento.numero_evento.toLowerCase().includes(searchTerm)) ||
            (evento.estado && evento.estado.toLowerCase().includes(searchTerm))
        );
        renderEventosTable(filteredEventos);
    });


    document.getElementById('filter-estado')?.addEventListener('change', function(e) {
        const estadoFiltro = e.target.value;
        const searchTerm = document.getElementById('search-eventos').value.toLowerCase();
        
        let filteredEventos = eventos;
        
        // Aplicar filtro de estado
        if (estadoFiltro) {
            filteredEventos = filteredEventos.filter(evento => evento.estado === estadoFiltro);
        }
        
        // Aplicar filtro de búsqueda
        if (searchTerm) {
            filteredEventos = filteredEventos.filter(evento => 
                (evento.cliente_nombre && evento.cliente_nombre.toLowerCase().includes(searchTerm)) ||
                (evento.lugar_evento && evento.lugar_evento.toLowerCase().includes(searchTerm)) ||
                (evento.numero_evento && evento.numero_evento.toLowerCase().includes(searchTerm))
            );
        }
        
        renderEventosTable(filteredEventos);
    });

    // Función auxiliar para obtener color de fondo según estado
    function getEstadoBackgroundColor(estado) {
        const colores = {
            'reservado': '#FEF3C7',
            'confirmado': '#D1FAE5',
            'pendiente_pago': '#DBEAFE',
            'cancelado': '#FEE2E2'
        };
        return colores[estado] || '#F9FAFB';
    }

    // Función para cambiar el estado del evento
    async function cambiarEstadoEvento(eventoId, nuevoEstado) {
        const descripciones = {
            'reservado': 'El evento estará reservado',
            'confirmado': 'El evento estará confirmado',
            'pendiente_pago': 'El evento quedará pendiente de pago',
            'cancelado': 'El evento será cancelado'
        };

        const confirmacion = await Swal.fire({
            title: '¿Cambiar estado del evento?',
            html: `
                <div style="text-align: left;">
                    <p>El estado cambiará a: <strong>${nuevoEstado.replace('_', ' ').toUpperCase()}</strong></p>
                    <p class="text-muted" style="font-size: 0.9rem; margin-top: 0.5rem;">
                        ${descripciones[nuevoEstado]}
                    </p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sí, cambiar',
            cancelButtonText: 'Cancelar'
        });

        if (!confirmacion.isConfirmed) {
            await loadEventos();
            return;
        }

        try {
            Swal.fire({
                title: 'Actualizando...',
                text: 'Cambiando estado del evento',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const response = await fetch(`/api/eventos/${eventoId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: nuevoEstado })
            });

            const data = await response.json();

            if (data.success) {
                Swal.fire('Éxito', 'Estado del evento actualizado correctamente', 'success');
                await loadEventos();
                
                const calendarioSection = document.getElementById('calendario');
                if (calendarioSection && calendarioSection.classList.contains('active')) {
                    await generateCalendar();
                }
                
                await loadDashboardData();
            } else {
                Swal.fire('Error', data.message, 'error');
                await loadEventos();
            }
        } catch (error) {
            console.error('Error cambiando estado del evento:', error);
            Swal.fire('Error', 'Error al cambiar estado del evento', 'error');
            await loadEventos();
        }
    }

    async function editarEvento(id) {
        try {
            const response = await fetch(`/api/eventos/${id}`);
            const data = await response.json();

            if (data.success) {
                const evento = data.evento;
                
                document.getElementById('edit-evento-id').value = evento.id_evento;
                document.getElementById('edit-evento-cliente').value = evento.id_cliente;
                document.getElementById('edit-evento-fecha').value = evento.fecha_evento;
                document.getElementById('edit-evento-hora-inicio').value = evento.hora_inicio || '';
                document.getElementById('edit-evento-hora-fin').value = evento.hora_fin || '';
                document.getElementById('edit-evento-lugar').value = evento.lugar_evento || '';
                document.getElementById('edit-evento-invitados').value = evento.numero_invitados || '';
                document.getElementById('edit-evento-estado').value = evento.estado;
                document.getElementById('edit-evento-notas').value = evento.notas || '';

                if (clientes.length === 0) {
                    await loadClientes();
                }

                openModal('editarEventoModal');
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error('Error loading evento for edit:', error);
            Swal.fire('Error', 'Error cargando datos del evento', 'error');
        }
    }

    async function actualizarEvento() {
        const id = document.getElementById('edit-evento-id').value;
        const clienteId = document.getElementById('edit-evento-cliente').value;
        const fecha = document.getElementById('edit-evento-fecha').value;
        const horaInicio = document.getElementById('edit-evento-hora-inicio').value;
        const horaFin = document.getElementById('edit-evento-hora-fin').value;
        const lugar = document.getElementById('edit-evento-lugar').value;
        const invitados = document.getElementById('edit-evento-invitados').value;
        const estado = document.getElementById('edit-evento-estado').value;
        const notas = document.getElementById('edit-evento-notas').value;

        if (!clienteId || !fecha) {
            Swal.fire('Error', 'Cliente y fecha son requeridos', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/eventos/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id_cliente: clienteId,
                    fecha_evento: fecha,
                    hora_inicio: horaInicio,
                    hora_fin: horaFin,
                    lugar_evento: lugar,
                    numero_invitados: invitados,
                    estado: estado,
                    notas: notas
                })
            });

            const data = await response.json();

            if (data.success) {
                Swal.fire('Éxito', 'Evento actualizado correctamente', 'success');
                closeModal('editarEventoModal');
                loadEventos();
                loadDashboardData();
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error('Error updating evento:', error);
            Swal.fire('Error', 'Error al actualizar evento', 'error');
        }
    }

    async function verEvento(id) {
        try {
            const response = await fetch(`/api/eventos/${id}`);
            const data = await response.json();

            if (data.success) {
                const evento = data.evento;
                
                const content = `
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Número de Evento</label>
                            <input type="text" class="form-control" value="${evento.numero_evento}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Cliente</label>
                            <input type="text" class="form-control" value="${evento.cliente_nombre}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="text" class="form-control" value="${formatDate(evento.fecha_evento)}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Horario</label>
                            <input type="text" class="form-control" value="${evento.hora_inicio} - ${evento.hora_fin}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Estado</label>
                            <input type="text" class="form-control" value="${evento.estado}" readonly>
                        </div>
                        <div class="form-group">
                            <label>Monto Total</label>
                            <input type="text" class="form-control" value="Q${parseFloat(evento.monto_total || 0).toFixed(2)}" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Lugar</label>
                        <input type="text" class="form-control" value="${evento.lugar_evento || ''}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea class="form-control" rows="3" readonly>${evento.notas || ''}</textarea>
                    </div>
                `;

                document.getElementById('detalle-evento-content').innerHTML = content;
                openModal('detalleEventoModal');
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error('Error loading evento detail:', error);
            Swal.fire('Error', 'Error cargando detalle del evento', 'error');
        }
    }

    // ===============================================
    // CARRITO DE EVENTOS
    // ===============================================
    function toggleEventoSection(sectionId) {
        const section = document.getElementById(sectionId);
        const isVisible = !section.classList.contains('hidden');
        
        if (isVisible) {
            section.classList.add('hidden');
        } else {
            section.classList.remove('hidden');
            
            if (sectionId === 'articulos-section' && articulosDisponibles.length === 0) {
                loadArticulosParaEvento();
            } else if (sectionId === 'servicios-section' && serviciosDisponibles.length === 0) {
                loadServiciosParaEvento();
            }
        }
    }

    async function loadArticulosParaEvento() {
        try {
            const response = await fetch('/api/articulos');
            const data = await response.json();
            
            if (data.success) {
                articulosDisponibles = data.articulos;
                renderArticulosGrid();
            }
        } catch (error) {
            console.error('Error loading artículos:', error);
        }
    }

    async function loadServiciosParaEvento() {
        try {
            const response = await fetch('/api/servicios');
            const data = await response.json();
            
            if (data.success) {
                serviciosDisponibles = data.servicios;
                renderServiciosGrid();
            }
        } catch (error) {
            console.error('Error loading servicios:', error);
        }
    }

    function renderArticulosGrid() {
        const grid = document.getElementById('articulos-grid');
        
        if (articulosDisponibles.length === 0) {
            grid.innerHTML = '<p class="text-muted">No hay artículos disponibles</p>';
            return;
        }
        
        grid.innerHTML = articulosDisponibles.map(articulo => `
            <div class="item-card" onclick="addItemToCart('articulo', ${articulo.id_articulo})">
                <h5>${articulo.nombre_articulo}</h5>
                <div class="price">Q${parseFloat(articulo.precio_unitario).toFixed(2)}</div>
                <div class="stock">Stock: ${articulo.cantidad_disponible}</div>
            </div>
        `).join('');
    }

    function renderServiciosGrid() {
        const grid = document.getElementById('servicios-grid');
        
        if (serviciosDisponibles.length === 0) {
            grid.innerHTML = '<p class="text-muted">No hay servicios disponibles</p>';
            return;
        }
        
        grid.innerHTML = serviciosDisponibles.map(servicio => `
            <div class="item-card" onclick="addItemToCart('servicio', ${servicio.id_servicio})">
                <h5>${servicio.nombre_servicio}</h5>
                <div class="price">Q${parseFloat(servicio.precio_fijo || servicio.precio_por_hora).toFixed(2)}</div>
                <div class="stock">${servicio.categoria}</div>
            </div>
        `).join('');
    }

    function addItemToCart(tipo, id) {
        let item;
        
        if (tipo === 'articulo') {
            item = articulosDisponibles.find(a => a.id_articulo === id);
            if (!item) return;
            
            const existing = eventoCart.find(c => c.tipo === 'articulo' && c.id === id);
            if (existing) {
                existing.cantidad++;
            } else {
                eventoCart.push({
                    tipo: 'articulo',
                    id: item.id_articulo,
                    nombre: item.nombre_articulo,
                    precio: parseFloat(item.precio_unitario),
                    cantidad: 1,
                    stock: item.cantidad_disponible
                });
            }
        } else if (tipo === 'servicio') {
            item = serviciosDisponibles.find(s => s.id_servicio === id);
            if (!item) return;
            
            const existing = eventoCart.find(c => c.tipo === 'servicio' && c.id === id);
            if (existing) {
                existing.cantidad++;
            } else {
                eventoCart.push({
                    tipo: 'servicio',
                    id: item.id_servicio,
                    nombre: item.nombre_servicio,
                    precio: parseFloat(item.precio_fijo || item.precio_por_hora),
                    cantidad: 1
                });
            }
        }
        
        renderCart();
    }

    function renderCart() {
        const tbody = document.getElementById('cart-body');
        
        if (eventoCart.length === 0) {
            tbody.innerHTML = '<tr class="empty-cart"><td colspan="5" class="text-center text-muted">No hay elementos en el carrito</td></tr>';
            document.getElementById('cart-total').textContent = '0.00';
            return;
        }
        
        let total = 0;
        
        tbody.innerHTML = eventoCart.map((item, index) => {
            const subtotal = item.precio * item.cantidad;
            total += subtotal;
            
            return `
                <tr>
                    <td>
                        <strong>${item.nombre}</strong>
                        <br><small class="text-muted">${item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1)}</small>
                    </td>
                    <td>Q${item.precio.toFixed(2)}</td>
                    <td>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="changeCartQuantity(${index}, -1)">-</button>
                            <div class="qty-display">${item.cantidad}</div>
                            <button class="qty-btn" onclick="changeCartQuantity(${index}, 1)">+</button>
                        </div>
                    </td>
                    <td>Q${subtotal.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('cart-total').textContent = total.toFixed(2);
    }

    function changeCartQuantity(index, delta) {
        const item = eventoCart[index];
        item.cantidad += delta;
        
        if (item.cantidad <= 0) {
            eventoCart.splice(index, 1);
        }
        
        renderCart();
    }

    function removeFromCart(index) {
        eventoCart.splice(index, 1);
        renderCart();
    }

    async function guardarEventoCompleto() {
        const tipoCliente = document.querySelector('input[name="cliente-tipo"]:checked').value;
        const fecha = document.getElementById('evento-fecha').value;
        
        if (!fecha) {
            Swal.fire('Error', 'La fecha del evento es requerida', 'error');
            return;
        }
        
        let clienteId;
        
        if (tipoCliente === 'nuevo') {
            const nombre = document.getElementById('nuevo-cliente-nombre').value.trim();
            const telefono = document.getElementById('nuevo-cliente-telefono').value.trim();
            const direccion = document.getElementById('nuevo-cliente-direccion').value.trim();
            const notas = document.getElementById('nuevo-cliente-notas').value.trim();
            
            if (!nombre) {
                Swal.fire('Error', 'El nombre del cliente es requerido', 'error');
                return;
            }
            
            try {
                const clienteResponse = await fetch('/api/clientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre, telefono, direccion, notas })
                });
                
                const clienteData = await clienteResponse.json();
                
                if (!clienteData.success) {
                    Swal.fire('Error', 'Error al crear cliente: ' + clienteData.message, 'error');
                    return;
                }
                
                clienteId = clienteData.cliente_id;
                await loadClientes();
                
            } catch (error) {
                console.error('Error creando cliente:', error);
                Swal.fire('Error', 'Error al crear cliente', 'error');
                return;
            }
        } else {
            clienteId = document.getElementById('evento-cliente').value;
            
            if (!clienteId) {
                Swal.fire('Error', 'Debe seleccionar un cliente', 'error');
                return;
            }
        }
        
        const eventoData = {
            id_cliente: parseInt(clienteId),
            fecha_evento: fecha,
            hora_inicio: document.getElementById('evento-hora-inicio').value,
            hora_fin: document.getElementById('evento-hora-fin').value,
            lugar_evento: document.getElementById('evento-lugar').value,
            numero_invitados: document.getElementById('evento-invitados').value ? parseInt(document.getElementById('evento-invitados').value) : null,
            notas: document.getElementById('evento-notas').value,
            monto_total: parseFloat(document.getElementById('cart-total').textContent),
            articulos: eventoCart.filter(item => item.tipo === 'articulo').map(item => ({
                id_articulo: item.id,
                cantidad: item.cantidad,
                precio_unitario: item.precio
            })),
            servicios: eventoCart.filter(item => item.tipo === 'servicio').map(item => ({
                id_servicio: item.id,
                cantidad: item.cantidad,
                precio_unitario: item.precio
            }))
        };
        
        try {
            const response = await fetch('/api/eventos/completo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(eventoData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                Swal.fire('Éxito', 'Evento guardado correctamente', 'success');
                closeModal('eventoModal');
                
                eventoCart = [];
                renderCart();
                document.getElementById('evento-form').reset();
                document.querySelector('input[name="cliente-tipo"][value="existente"]').checked = true;
                toggleClienteForm('existente');
                
                loadEventos();
                loadDashboardData();
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error('Error saving evento completo:', error);
            Swal.fire('Error', 'Error al guardar evento', 'error');
        }
    }

    // ===============================================
    // GESTIÓN DE ARTÍCULOS
    // ===============================================
    async function loadArticulos() {
        try {
            const response = await fetch('/api/articulos');
            const data = await response.json();
            
            if (data.success) {
                articulos = data.articulos;
                renderArticulosTable();
            }
        } catch (error) {
            console.error('Error loading articulos:', error);
        }
    }


        function renderArticulosTable() {
        const tbody = document.getElementById('articulos-table-body');
        
        if (articulos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay artículos registrados</td></tr>';
            return;
        }

        tbody.innerHTML = articulos.map(articulo => `
            <tr>
                <td>${articulo.codigo}</td>
                <td>${articulo.nombre_articulo}</td>
                <td>${articulo.categoria_nombre}</td>
                <td>${articulo.cantidad_total}</td>
                <td>${articulo.cantidad_disponible}</td>
                <td>Q${parseFloat(articulo.precio_unitario).toFixed(2)}</td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="editarArticulo(${articulo.id_articulo})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }



    async function guardarArticulo() {
        const codigo = document.getElementById('articulo-codigo').value;
        const nombre = document.getElementById('articulo-nombre').value;
        const categoria = document.getElementById('articulo-categoria').value;
        const precio = document.getElementById('articulo-precio').value;
        const cantidad = document.getElementById('articulo-cantidad').value;
        const costo = document.getElementById('articulo-costo').value;
        const descripcion = document.getElementById('articulo-descripcion').value;

        if (!codigo || !nombre || !categoria || !precio || !cantidad) {
            Swal.fire('Error', 'Todos los campos marcados son requeridos', 'error');
            return;
        }

        try {
            const response = await fetch('/api/articulos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    codigo,
                    nombre_articulo: nombre,
                    id_categoria: categoria,
                    precio_unitario: precio,
                    cantidad_total: cantidad,
                    costo_reposicion: costo,
                    descripcion
                })
            });

            const data = await response.json();

            if (data.success) {
                Swal.fire('Éxito', 'Artículo guardado correctamente', 'success');
                closeModal('articuloModal');
                loadArticulos();
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error('Error saving articulo:', error);
            Swal.fire('Error', 'Error al guardar artículo', 'error');
        }
    }

    async function editarArticulo(id) {
        try {
            const articulo = articulos.find(a => a.id_articulo === id);
            if (!articulo) {
                Swal.fire('Error', 'Artículo no encontrado', 'error');
                return;
            }

            // Crear modal de edición
            const { value: formValues } = await Swal.fire({
                title: 'Editar Artículo',
                html: `
                    <div style="text-align: left;">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Código</label>
                            <input id="edit-articulo-codigo" class="swal2-input" style="width: 90%; margin: 0;" value="${articulo.codigo}" />
                        </div>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nombre</label>
                            <input id="edit-articulo-nombre" class="swal2-input" style="width: 90%; margin: 0;" value="${articulo.nombre_articulo}" />
                        </div>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Precio Unitario</label>
                            <input id="edit-articulo-precio" type="number" class="swal2-input" style="width: 90%; margin: 0;" value="${articulo.precio_unitario}" step="0.01" />
                        </div>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Cantidad Total</label>
                            <input id="edit-articulo-cantidad" type="number" class="swal2-input" style="width: 90%; margin: 0;" value="${articulo.cantidad_total}" />
                        </div>
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Descripción</label>
                            <textarea id="edit-articulo-descripcion" class="swal2-textarea" style="width: 90%; margin: 0;">${articulo.descripcion || ''}</textarea>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Actualizar',
                cancelButtonText: 'Cancelar',
                width: '600px',
                preConfirm: () => {
                    const codigo = document.getElementById('edit-articulo-codigo').value;
                    const nombre = document.getElementById('edit-articulo-nombre').value;
                    const precio = document.getElementById('edit-articulo-precio').value;
                    const cantidad = document.getElementById('edit-articulo-cantidad').value;
                    const descripcion = document.getElementById('edit-articulo-descripcion').value;
                    
                    if (!codigo || !nombre || !precio || !cantidad) {
                        Swal.showValidationMessage('Todos los campos son requeridos');
                        return false;
                    }
                    
                    return {
                        codigo,
                        nombre_articulo: nombre,
                        precio_unitario: parseFloat(precio),
                        cantidad_total: parseInt(cantidad),
                        descripcion
                    };
                }
            });

            if (formValues) {
                try {
                    const response = await fetch(`/api/articulos/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formValues)
                    });

                    const data = await response.json();

                    if (data.success) {
                        Swal.fire('Éxito', 'Artículo actualizado correctamente', 'success');
                        loadArticulos();
                    } else {
                        Swal.fire('Error', data.message, 'error');
                    }
                } catch (error) {
                    console.error('Error actualizando artículo:', error);
                    Swal.fire('Error', 'Error al actualizar artículo', 'error');
                }
            }
        } catch (error) {
            console.error('Error en editarArticulo:', error);
            Swal.fire('Error', 'Error al abrir el formulario', 'error');
        }
    }

    // Función para eliminar artículo
    async function eliminarArticulo(id) {
        try {
            // Verificar si el artículo está en uso
            const checkResponse = await fetch(`/api/articulos/${id}/puede-eliminar`);
            const checkData = await checkResponse.json();
            
            let warningMessage = '¿Estás seguro de eliminar este artículo?';
            if (checkData.en_uso) {
                warningMessage = `<div style="text-align: left;">
                    <p><strong>⚠️ Advertencia:</strong></p>
                    <p>Este artículo está siendo utilizado en ${checkData.eventos_count} evento(s).</p>
                    <p style="margin-top: 1rem;">No se recomienda eliminarlo. Considera marcarlo como inactivo en su lugar.</p>
                </div>`;
            }
            
            const result = await Swal.fire({
                title: 'Confirmar Eliminación',
                html: warningMessage,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: checkData.en_uso ? 'Eliminar de todos modos' : 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#EF4444'
            });

            if (result.isConfirmed) {
                const response = await fetch(`/api/articulos/${id}`, { 
                    method: 'DELETE' 
                });
                const data = await response.json();
                
                if (data.success) {
                    Swal.fire('Eliminado', 'Artículo eliminado correctamente', 'success');
                    loadArticulos();
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            }
        } catch (error) {
            console.error('Error eliminando artículo:', error);
            Swal.fire('Error', 'Error al eliminar artículo', 'error');
        }
    }

    async function abrirMovimiento(articuloId, articuloNombre) {
        document.getElementById('movimiento-articulo-id').value = articuloId;
        document.getElementById('movimiento-articulo-nombre').value = articuloNombre;
        document.getElementById('movimiento-responsable').value = "{{ user.name if user else '' }}";
        
        openModal('movimientoModal');
    }

    async function guardarMovimiento() {
        const articuloId = document.getElementById('movimiento-articulo-id').value;
        const tipo = document.getElementById('movimiento-tipo').value;
        const cantidad = document.getElementById('movimiento-cantidad').value;
        const responsable = document.getElementById('movimiento-responsable').value;
        const observaciones = document.getElementById('movimiento-observaciones').value;

        if (!tipo || !cantidad) {
            Swal.fire('Error', 'Tipo de movimiento y cantidad son requeridos', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/articulos/${articuloId}/movimiento`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tipo_movimiento: tipo,
                    cantidad: parseInt(cantidad),
                    responsable,
                    observaciones
                })
            });

            const data = await response.json();

            if (data.success) {
                Swal.fire('Éxito', 'Movimiento registrado correctamente', 'success');
                closeModal('movimientoModal');
                loadArticulos();
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error('Error saving movimiento:', error);
            Swal.fire('Error', 'Error al registrar movimiento', 'error');
        }
    }

    // ===============================================
    // GESTIÓN DE COTIZACIONES
    // ===============================================
    async function loadCotizaciones() {
        try {
            const response = await fetch('/api/cotizaciones');
            const data = await response.json();
            
            if (data.success) {
                renderCotizacionesTable(data.cotizaciones);
            }
        } catch (error) {
            console.error('Error loading cotizaciones:', error);
        }
    }

    function renderCotizacionesTable(cotizaciones) {
        const tbody = document.getElementById('cotizaciones-table-body');
        
        if (cotizaciones.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay cotizaciones registradas</td></tr>';
            return;
        }

        tbody.innerHTML = cotizaciones.map(cotizacion => `
            <tr>
                <td><strong>${cotizacion.numero_cotizacion}</strong></td>
                <td>${cotizacion.cliente_nombre || '<em>Sin cliente definido</em>'}</td>
                <td>${formatDate(cotizacion.fecha_evento)}</td>
                <td>Q${parseFloat(cotizacion.monto_total || 0).toFixed(2)}</td>
                <td><span class="status-badge status-${cotizacion.estado}">${cotizacion.estado}</span></td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="verCotizacionCompleta(${cotizacion.id_cotizacion})" title="Ver Detalle">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-success btn-sm" onclick="descargarCotizacionPDF(${cotizacion.id_cotizacion})" title="Descargar PDF">
                        <i class="fas fa-download"></i>
                    </button>
                    ${cotizacion.estado === 'enviada' || cotizacion.estado === 'borrador' ? `
                        <button class="btn btn-warning btn-sm" onclick="editarCotizacion(${cotizacion.id_cotizacion})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-info btn-sm" onclick="aprobarCotizacion(${cotizacion.id_cotizacion})" title="Aprobar">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                    ${cotizacion.estado === 'borrador' || cotizacion.estado === 'rechazada' ? `
                        <button class="btn btn-danger btn-sm" onclick="eliminarCotizacion(${cotizacion.id_cotizacion})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </td>
            </tr>
        `).join('');
    }

    // Función para editar cotización
    async function editarCotizacion(cotizacionId) {
        try {
            Swal.fire({
                title: 'Cargando...',
                text: 'Obteniendo datos de la cotización',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const response = await fetch(`/api/cotizaciones/${cotizacionId}/detalle`);
            const data = await response.json();

            if (data.success) {
                const cotizacion = data.cotizacion;
                
                // Llenar formulario con datos existentes
                document.getElementById('cotizacion-cliente').value = cotizacion.id_cliente || '';
                document.getElementById('cotizacion-fecha').value = cotizacion.fecha_evento || '';
                document.getElementById('cotizacion-hora-inicio').value = cotizacion.hora_inicio || '';
                document.getElementById('cotizacion-hora-fin').value = cotizacion.hora_fin || '';
                document.getElementById('cotizacion-lugar').value = cotizacion.lugar_evento || '';
                document.getElementById('cotizacion-invitados').value = cotizacion.numero_invitados || '';
                document.getElementById('cotizacion-notas').value = cotizacion.notas || '';
                
                // Limpiar carrito y agregar items existentes
                cotizacionCart = [];
                
                // Agregar artículos al carrito
                cotizacion.articulos.forEach(articulo => {
                    cotizacionCart.push({
                        tipo: 'articulo',
                        id: articulo.id_articulo,
                        nombre: articulo.nombre_articulo,
                        precio: parseFloat(articulo.precio_unitario),
                        cantidad: articulo.cantidad
                    });
                });
                
                // Agregar servicios al carrito
                cotizacion.servicios.forEach(servicio => {
                    cotizacionCart.push({
                        tipo: 'servicio',
                        id: servicio.id_servicio,
                        nombre: servicio.nombre_servicio,
                        precio: parseFloat(servicio.precio_unitario),
                        cantidad: servicio.cantidad_horas
                    });
                });
                
                renderCotizacionCart();
                
                // Mostrar secciones si hay items
                if (cotizacion.articulos.length > 0) {
                    document.getElementById('toggleArticulosCot').checked = true;
                    document.getElementById('articulos-section-cot').classList.remove('hidden');
                    await loadArticulosParaCotizacion();
                }
                
                if (cotizacion.servicios.length > 0) {
                    document.getElementById('toggleServiciosCot').checked = true;
                    document.getElementById('servicios-section-cot').classList.remove('hidden');
                    await loadServiciosParaCotizacion();
                }
                
                // Guardar ID para actualización
                cotizacionActualId = cotizacionId;
                
                Swal.close();
                openModal('cotizacionModal');
                
                // Cambiar el botón de guardar por actualizar
                const saveButton = document.querySelector('#cotizacionModal .modal-footer .btn-primary');
                saveButton.innerHTML = '<i class="fas fa-save"></i> Actualizar Cotización';
                saveButton.onclick = () => actualizarCotizacion(cotizacionId);
                
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error('Error cargando cotización:', error);
            Swal.fire('Error', 'Error al cargar la cotización', 'error');
        }
    }

    // Función para actualizar cotización
    async function actualizarCotizacion(cotizacionId) {
        const cotizacionData = {
            id_cliente: document.getElementById('cotizacion-cliente').value || null,
            fecha_evento: document.getElementById('cotizacion-fecha').value,
            hora_inicio: document.getElementById('cotizacion-hora-inicio').value,
            hora_fin: document.getElementById('cotizacion-hora-fin').value,
            lugar_evento: document.getElementById('cotizacion-lugar').value,
            numero_invitados: document.getElementById('cotizacion-invitados').value ? parseInt(document.getElementById('cotizacion-invitados').value) : null,
            notas: document.getElementById('cotizacion-notas').value,
            monto_total: parseFloat(document.getElementById('cart-total-cot').textContent),
            articulos: cotizacionCart.filter(item => item.tipo === 'articulo').map(item => ({
                id_articulo: item.id,
                cantidad: item.cantidad,
                precio_unitario: item.precio
            })),
            servicios: cotizacionCart.filter(item => item.tipo === 'servicio').map(item => ({
                id_servicio: item.id,
                cantidad: item.cantidad,
                precio_unitario: item.precio
            }))
        };
        
        try {
            const response = await fetch(`/api/cotizaciones/${cotizacionId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cotizacionData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                Swal.fire('Éxito', 'Cotización actualizada correctamente', 'success');
                closeModal('cotizacionModal');
                
                // Resetear el botón
                const saveButton = document.querySelector('#cotizacionModal .modal-footer .btn-primary');
                saveButton.innerHTML = '<i class="fas fa-save"></i> Guardar Cotización';
                saveButton.onclick = guardarCotizacionCompleta;
                
                cotizacionCart = [];
                cotizacionActualId = null;
                renderCotizacionCart();
                
                loadCotizaciones();
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error('Error actualizando cotización:', error);
            Swal.fire('Error', 'Error al actualizar cotización', 'error');
        }
    }

    // Función para eliminar cotización (solo borradores y rechazadas)
    async function eliminarCotizacion(cotizacionId) {
        const result = await Swal.fire({
            title: '¿Eliminar cotización?',
            html: `
                <div style="text-align: left;">
                    <p>Esta acción eliminará permanentemente la cotización.</p>
                    <p class="text-muted" style="font-size: 0.9rem; margin-top: 0.5rem;">
                        Solo se pueden eliminar cotizaciones en estado "borrador" o "rechazada".
                    </p>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#EF4444'
        });

        if (result.isConfirmed) {
            try {
                // NOTA: La eliminación solo borrará el registro de cotización
                // NO afectará artículos ni otros datos del sistema
                const response = await fetch(`/api/cotizaciones/${cotizacionId}`, { 
                    method: 'DELETE' 
                });
                const data = await response.json();
                
                if (data.success) {
                    Swal.fire('Eliminado', 'Cotización eliminada correctamente', 'success');
                    loadCotizaciones();
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            } catch (error) {
                console.error('Error eliminando cotización:', error);
                Swal.fire('Error', 'Error al eliminar cotización', 'error');
            }
        }
    }

    async function verCotizacionCompleta(cotizacionId) {
        try {
            const response = await fetch(`/api/cotizaciones/${cotizacionId}/detalle`);
            const data = await response.json();

            if (data.success) {
                const cotizacion = data.cotizacion;
                
                const articulosHtml = cotizacion.articulos.map(a => `
                    <tr>
                        <td>${a.codigo}</td>
                        <td>${a.nombre_articulo}</td>
                        <td>${a.cantidad}</td>
                        <td>Q${a.precio_unitario.toFixed(2)}</td>
                        <td>Q${a.subtotal.toFixed(2)}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center text-muted">Sin artículos</td></tr>';

                const serviciosHtml = cotizacion.servicios.map(s => `
                    <tr>
                        <td>${s.codigo}</td>
                        <td>${s.nombre_servicio}</td>
                        <td>${s.cantidad_horas}</td>
                        <td>Q${s.precio_unitario.toFixed(2)}</td>
                        <td>Q${s.subtotal.toFixed(2)}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center text-muted">Sin servicios</td></tr>';
                
                const content = `
                    <div style="text-align: left;">
                        <h4>Información General</h4>
                        <p><strong>Cliente:</strong> ${cotizacion.cliente_nombre || 'Sin cliente definido'}</p>
                        <p><strong>Fecha Evento:</strong> ${formatDate(cotizacion.fecha_evento)}</p>
                        <p><strong>Lugar:</strong> ${cotizacion.lugar_evento || 'Por definir'}</p>
                        <p><strong>Invitados:</strong> ${cotizacion.numero_invitados || 'Por definir'}</p>
                        
                        <h4 style="margin-top: 1rem;">Artículos</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 0.5rem; border: 1px solid #ddd;">Código</th>
                                    <th style="padding: 0.5rem; border: 1px solid #ddd;">Artículo</th>
                                    <th style="padding: 0.5rem; border: 1px solid #ddd;">Cant.</th>
                                    <th style="padding: 0.5rem; border: 1px solid #ddd;">Precio</th>
                                    <th style="padding: 0.5rem; border: 1px solid #ddd;">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>${articulosHtml}</tbody>
                        </table>
                        
                        <h4 style="margin-top: 1rem;">Servicios</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 0.5rem; border: 1px solid #ddd;">Código</th>
                                    <th style="padding: 0.5rem; border: 1px solid #ddd;">Servicio</th>
                                    <th style="padding: 0.5rem; border: 1px solid #ddd;">Horas</th>
                                    <th style="padding: 0.5rem; border: 1px solid #ddd;">Precio</th>
                                    <th style="padding: 0.5rem; border: 1px solid #ddd;">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>${serviciosHtml}</tbody>
                        </table>
                        
                        <h3 style="margin-top: 1rem; text-align: right;">Total: Q${cotizacion.monto_total.toFixed(2)}</h3>
                    </div>
                `;
                
                Swal.fire({
                    title: `Cotización ${cotizacion.numero_cotizacion}`,
                    html: content,
                    width: '900px',
                    showCloseButton: true,
                    showConfirmButton: false
                });
            }
        } catch (error) {
            console.error('Error loading cotización:', error);
            Swal.fire('Error', 'Error cargando detalle de cotización', 'error');
        }
    }

    function aprobarCotizacion(cotizacionId) {
        aprobarCotizacionDirecta(cotizacionId);
    }

    function toggleCotizacionSection(sectionId) {
        const section = document.getElementById(sectionId);
        const isVisible = !section.classList.contains('hidden');
        
        if (isVisible) {
            section.classList.add('hidden');
        } else {
            section.classList.remove('hidden');
            
            if (sectionId === 'articulos-section-cot' && articulosDisponibles.length === 0) {
                loadArticulosParaCotizacion();
            } else if (sectionId === 'servicios-section-cot' && serviciosDisponibles.length === 0) {
                loadServiciosParaCotizacion();
            }
        }
    }

    async function loadArticulosParaCotizacion() {
        try {
            const response = await fetch('/api/articulos');
            const data = await response.json();
            
            if (data.success) {
                articulosDisponibles = data.articulos;
                renderArticulosGridCotizacion();
            }
        } catch (error) {
            console.error('Error loading artículos:', error);
        }
    }

    async function loadServiciosParaCotizacion() {
        try {
            const response = await fetch('/api/servicios');
            const data = await response.json();
            
            if (data.success) {
                serviciosDisponibles = data.servicios;
                renderServiciosGridCotizacion();
            }
        } catch (error) {
            console.error('Error loading servicios:', error);
        }
    }

    function renderArticulosGridCotizacion() {
        const grid = document.getElementById('articulos-grid-cot');
        
        if (articulosDisponibles.length === 0) {
            grid.innerHTML = '<p class="text-muted">No hay artículos disponibles</p>';
            return;
        }
        
        grid.innerHTML = articulosDisponibles.map(articulo => `
            <div class="item-card" onclick="addItemToCotizacionCart('articulo', ${articulo.id_articulo})">
                <h5>${articulo.nombre_articulo}</h5>
                <div class="price">Q${parseFloat(articulo.precio_unitario).toFixed(2)}</div>
                <div class="stock">Stock: ${articulo.cantidad_disponible}</div>
            </div>
        `).join('');
    }

    function renderServiciosGridCotizacion() {
        const grid = document.getElementById('servicios-grid-cot');
        
        if (serviciosDisponibles.length === 0) {
            grid.innerHTML = '<p class="text-muted">No hay servicios disponibles</p>';
            return;
        }
        
        grid.innerHTML = serviciosDisponibles.map(servicio => `
            <div class="item-card" onclick="addItemToCotizacionCart('servicio', ${servicio.id_servicio})">
                <h5>${servicio.nombre_servicio}</h5>
                <div class="price">Q${parseFloat(servicio.precio_fijo || servicio.precio_por_hora).toFixed(2)}</div>
                <div class="stock">${servicio.categoria}</div>
            </div>
        `).join('');
    }

    function addItemToCotizacionCart(tipo, id) {
        let item;
        
        if (tipo === 'articulo') {
            item = articulosDisponibles.find(a => a.id_articulo === id);
            if (!item) return;
            
            const existing = cotizacionCart.find(c => c.tipo === 'articulo' && c.id === id);
            if (existing) {
                existing.cantidad++;
            } else {
                cotizacionCart.push({
                    tipo: 'articulo',
                    id: item.id_articulo,
                    nombre: item.nombre_articulo,
                    precio: parseFloat(item.precio_unitario),
                    cantidad: 1
                });
            }
        } else if (tipo === 'servicio') {
            item = serviciosDisponibles.find(s => s.id_servicio === id);
            if (!item) return;
            
            const existing = cotizacionCart.find(c => c.tipo === 'servicio' && c.id === id);
            if (existing) {
                existing.cantidad++;
            } else {
                cotizacionCart.push({
                    tipo: 'servicio',
                    id: item.id_servicio,
                    nombre: item.nombre_servicio,
                    precio: parseFloat(item.precio_fijo || item.precio_por_hora),
                    cantidad: 1
                });
            }
        }
        
        renderCotizacionCart();
    }

    function renderCotizacionCart() {
        const tbody = document.getElementById('cart-body-cot');
        
        if (cotizacionCart.length === 0) {
            tbody.innerHTML = '<tr class="empty-cart"><td colspan="5" class="text-center text-muted">No hay elementos en la cotización</td></tr>';
            document.getElementById('cart-total-cot').textContent = '0.00';
            return;
        }
        
        let total = 0;
        
        tbody.innerHTML = cotizacionCart.map((item, index) => {
            const subtotal = item.precio * item.cantidad;
            total += subtotal;
            
            return `
                <tr>
                    <td>
                        <strong>${item.nombre}</strong>
                        <br><small class="text-muted">${item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1)}</small>
                    </td>
                    <td>Q${item.precio.toFixed(2)}</td>
                    <td>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="changeCotizacionCartQuantity(${index}, -1)">-</button>
                            <div class="qty-display">${item.cantidad}</div>
                            <button class="qty-btn" onclick="changeCotizacionCartQuantity(${index}, 1)">+</button>
                        </div>
                    </td>
                    <td>Q${subtotal.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeFromCotizacionCart(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('cart-total-cot').textContent = total.toFixed(2);
    }

    function changeCotizacionCartQuantity(index, delta) {
        const item = cotizacionCart[index];
        item.cantidad += delta;
        
        if (item.cantidad <= 0) {
            cotizacionCart.splice(index, 1);
        }
        
        renderCotizacionCart();
    }

    function removeFromCotizacionCart(index) {
        cotizacionCart.splice(index, 1);
        renderCotizacionCart();
    }

    async function guardarCotizacionCompleta() {
        const cotizacionData = {
            id_cliente: document.getElementById('cotizacion-cliente').value || null,
            fecha_evento: document.getElementById('cotizacion-fecha').value,
            hora_inicio: document.getElementById('cotizacion-hora-inicio').value,
            hora_fin: document.getElementById('cotizacion-hora-fin').value,
            lugar_evento: document.getElementById('cotizacion-lugar').value,
            numero_invitados: document.getElementById('cotizacion-invitados').value ? parseInt(document.getElementById('cotizacion-invitados').value) : null,
            notas: document.getElementById('cotizacion-notas').value,
            monto_total: parseFloat(document.getElementById('cart-total-cot').textContent),
            articulos: cotizacionCart.filter(item => item.tipo === 'articulo').map(item => ({
                id_articulo: item.id,
                cantidad: item.cantidad,
                precio_unitario: item.precio
            })),
            servicios: cotizacionCart.filter(item => item.tipo === 'servicio').map(item => ({
                id_servicio: item.id,
                cantidad: item.cantidad,
                precio_unitario: item.precio
            }))
        };
        
        try {
            const response = await fetch('/api/cotizaciones/completa', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cotizacionData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                cotizacionActualId = data.cotizacion_id;
                
                Swal.fire({
                    title: 'Cotización Guardada',
                    html: `
                        <p>Cotización <strong>${data.numero_cotizacion}</strong> creada exitosamente</p>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn btn-primary" onclick="descargarCotizacionPDF(${data.cotizacion_id})">
                                <i class="fas fa-download"></i> Descargar PDF
                            </button>
                            <button class="btn btn-success" onclick="aprobarCotizacionDirecta(${data.cotizacion_id})">
                                <i class="fas fa-check"></i> Aprobar y Crear Evento
                            </button>
                        </div>
                    `,
                    icon: 'success',
                    showConfirmButton: false,
                    showCloseButton: true
                });
                
                closeModal('cotizacionModal');
                
                cotizacionCart = [];
                renderCotizacionCart();
                
                loadCotizaciones();
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        } catch (error) {
            console.error('Error guardando cotización:', error);
            Swal.fire('Error', 'Error al guardar cotización', 'error');
        }
    }

    function descargarCotizacionPDF(cotizacionId) {
        window.open(`/api/cotizaciones/${cotizacionId}/pdf`, '_blank');
        Swal.close();
    }

    async function aprobarCotizacionDirecta(cotizacionId) {
        const { value: clienteId } = await Swal.fire({
            title: 'Aprobar Cotización',
            html: `
                <div style="text-align: left;">
                    <label>Seleccione el cliente para el evento:</label>
                    <select id="swal-cliente" class="form-control" style="width: 100%; padding: 0.5rem; margin-top: 0.5rem;">
                        <option value="">Seleccionar cliente...</option>
                        ${clientes.map(c => `<option value="${c.id_cliente}">${c.nombre}</option>`).join('')}
                    </select>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Aprobar',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                const clienteId = document.getElementById('swal-cliente').value;
                if (!clienteId) {
                    Swal.showValidationMessage('Debe seleccionar un cliente');
                    return false;
                }
                return clienteId;
            }
        });
        
        if (clienteId) {
            try {
                const response = await fetch(`/api/cotizaciones/${cotizacionId}/aprobar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_cliente: parseInt(clienteId) })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    Swal.fire('Éxito', `Evento ${data.numero_evento} creado exitosamente`, 'success');
                    loadCotizaciones();
                    loadEventos();
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            } catch (error) {
                console.error('Error aprobando cotización:', error);
                Swal.fire('Error', 'Error al aprobar cotización', 'error');
            }
        }
    }

    // ===============================================
    // GESTIÓN DE INVENTARIO (ARTÍCULOS POR EVENTO)
    // ===============================================
    async function loadEventosConArticulos() {
        try {
            const response = await fetch('/api/eventos/articulos/gestion');
            const data = await response.json();
            
            if (data.success) {
                eventosGestion = data.eventos;
                renderEventosGestion();
            }
        } catch (error) {
            console.error('Error loading eventos con artículos:', error);
        }
    }

    function renderEventosGestion() {
        const tbody = document.getElementById('gestion-eventos-table-body');
        
        if (eventosGestion.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay eventos con artículos pendientes</td></tr>';
            return;
        }

        tbody.innerHTML = eventosGestion.map(evento => {
            const porcentaje = Math.round(((evento.articulos_devueltos || 0) / evento.total_articulos) * 100);
            
            return `
                <tr>
                    <td><strong>${evento.numero_evento}</strong></td>
                    <td>${evento.cliente_nombre}</td>
                    <td>${formatDate(evento.fecha_evento)}</td>
                    <td><span class="status-badge status-${evento.estado}">${evento.estado}</span></td>
                    <td>${evento.total_articulos}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="flex: 1; background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${porcentaje}%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--primary-light)); transition: width 0.3s;"></div>
                            </div>
                            <small style="min-width: 40px;">${porcentaje}%</small>
                        </div>
                        <small class="text-muted">
                            Reservados: ${evento.articulos_reservados} | 
                            Entregados: ${evento.articulos_entregados} | 
                            Recogido: ${evento.articulos_devueltos}
                        </small>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="abrirGestionArticulosEvento(${evento.id_evento})" title="Gestionar Artículos">
                            <i class="fas fa-tasks"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function abrirGestionArticulosEvento(eventoId) {
        console.log('🔍 Intentando abrir gestión de artículos para evento:', eventoId);
        
        try {
            if (!eventoId || eventoId === 'undefined' || eventoId === 'null') {
                console.error('❌ ID de evento inválido:', eventoId);
                Swal.fire('Error', 'ID de evento inválido', 'error');
                return;
            }

            Swal.fire({
                title: 'Cargando...',
                text: 'Obteniendo artículos del evento',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            console.log('📡 Haciendo petición a:', `/api/eventos/${eventoId}/articulos`);
            
            const response = await fetch(`/api/eventos/${eventoId}/articulos`);
            
            console.log('📥 Respuesta recibida. Status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            console.log('📦 Datos recibidos:', data);
            
            if (data.success) {
                eventoGestionActual = data.evento;
                articulosGestionActual = data.articulos;
                
                console.log('✅ Evento:', eventoGestionActual);
                console.log('✅ Artículos cargados:', articulosGestionActual.length);
                
                document.getElementById('gestion-evento-numero').textContent = data.evento.numero_evento || 'N/A';
                document.getElementById('gestion-cliente-nombre').textContent = data.evento.cliente_nombre || 'Sin cliente';
                document.getElementById('gestion-fecha-evento').textContent = formatDate(data.evento.fecha_evento);
                document.getElementById('gestion-estado-evento').textContent = data.evento.estado || 'N/A';
                
                renderArticulosGestion();
                
                Swal.close();
                openModal('gestionArticulosEventoModal');
                
            } else {
                console.error('❌ Error en respuesta:', data.message);
                Swal.fire('Error', data.message || 'Error desconocido', 'error');
            }
        } catch (error) {
            console.error('❌ Error completo:', error);
            console.error('Stack trace:', error.stack);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                html: `
                    <p>Error cargando artículos del evento</p>
                    <small style="color: #666;">Detalles: ${error.message}</small>
                    <br><small style="color: #999;">Revisa la consola (F12) para más información</small>
                `
            });
        }
    }

    function renderArticulosGestion() {
        const tbody = document.getElementById('gestion-articulos-detalle-body');
        
        if (articulosGestionActual.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay artículos en este evento</td></tr>';
            return;
        }

        tbody.innerHTML = articulosGestionActual.map(articulo => {
            const estadoColor = getEstadoColor(articulo.estado_articulo);
            const fechas = getFechasArticuloSimplificado(articulo);
            
            return `
                <tr>
                    <td><code>${articulo.codigo}</code></td>
                    <td><strong>${articulo.nombre_articulo}</strong></td>
                    <td>${articulo.cantidad_solicitada}</td>
                    <td>
                        <span style="${articulo.stock_actual < 10 ? 'color: #EF4444; font-weight: 600;' : 'color: #10B981; font-weight: 600;'}">
                            ${articulo.stock_actual}
                        </span>
                    </td>
                    <td>
                        <select class="form-control" style="padding: 0.5rem; font-size: 0.875rem; background: ${estadoColor}; font-weight: 600; border: 2px solid rgba(0,0,0,0.1);" 
                                onchange="cambiarEstadoArticulo(${articulo.id_detalle}, this.value, ${articulo.id_articulo})">
                            <option value="reservado" ${articulo.estado_articulo === 'reservado' ? 'selected' : ''}>Reservado</option>
                            <option value="entregado" ${articulo.estado_articulo === 'entregado' ? 'selected' : ''}>Entregado</option>
                            <option value="recogido" ${articulo.estado_articulo === 'recogido' ? 'selected' : ''}>Recogido</option>
                            <option value="con_problemas" ${articulo.estado_articulo === 'con_problemas' ? 'selected' : ''}>Con Problemas</option>
                        </select>
                    </td>
                    <td style="font-size: 0.75rem;">
                        ${fechas}
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="verDetalleArticuloEvento(${articulo.id_detalle})" title="Ver Detalle">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Mostrar/ocultar botón "Escribe el problema"
        mostrarBotonEscribirProblema();
    }


    function getFechasArticuloSimplificado(articulo) {
        let fechas = [];
        
        if (articulo.fecha_entrega) {
            fechas.push(`<div><strong>Entregado:</strong> ${formatDateTimeFull(articulo.fecha_entrega)}</div>`);
        }
        if (articulo.fecha_devolucion) {
            fechas.push(`<div><strong>Recogido:</strong> ${formatDateTimeFull(articulo.fecha_devolucion)}</div>`);
        }
        
        if (fechas.length === 0) {
            return '<span class="text-muted" style="font-style: italic;">Sin fechas</span>';
        }
        
        return fechas.join('');
    }

    function getEstadoColor(estado) {
        const colores = {
            'reservado': '#FEF3C7',
            'entregado': '#DBEAFE',
            'recogido': '#D1FAE5',
            'con_problemas': '#FEE2E2'
        };
        return colores[estado] || '#F9FAFB';
    }

    async function cambiarEstadoArticulo(detalleId, nuevoEstado, articuloId) {
        try {
            let eventoId = eventoGestionActual?.id_evento;
            
            if (!eventoId && articulosGestionActual.length > 0) {
                const response = await fetch(`/api/eventos/articulos/gestion`);
                const data = await response.json();
                if (data.success && data.eventos.length > 0) {
                    eventoId = data.eventos[0].id_evento;
                }
            }
            
            if (!eventoId) {
                Swal.fire('Error', 'No se pudo determinar el evento', 'error');
                return;
            }

            const descripciones = {
                'reservado': 'El artículo estará reservado para el evento',
                'entregado': 'El artículo será entregado al cliente (se descuenta del stock)',
                'recogido': 'El artículo será recogido del cliente (se regresa al stock)',
                'con_problemas': 'El artículo presenta problemas'
            };

            const confirmacion = await Swal.fire({
                title: '¿Cambiar estado?',
                html: `
                    <div style="text-align: left;">
                        <p>El estado cambiará a: <strong>${nuevoEstado.toUpperCase()}</strong></p>
                        <p class="text-muted" style="font-size: 0.9rem; margin-top: 0.5rem;">
                            ${descripciones[nuevoEstado]}
                        </p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, cambiar',
                cancelButtonText: 'Cancelar'
            });

            if (!confirmacion.isConfirmed) {
                await abrirGestionArticulosEvento(eventoId);
                return;
            }

            Swal.fire({
                title: 'Actualizando...',
                text: 'Cambiando estado del artículo',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const response = await fetch(`/api/eventos/${eventoId}/articulos/${detalleId}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado_articulo: nuevoEstado })
            });

            const data = await response.json();

            if (data.success) {
                Swal.fire('Éxito', data.message, 'success');
                
                setTimeout(async () => {
                    await abrirGestionArticulosEvento(eventoId);
                    await loadEventosConArticulos();
                }, 300);
                
            } else {
                Swal.fire('Error', data.message, 'error');
                await abrirGestionArticulosEvento(eventoId);
            }
        } catch (error) {
            console.error('Error cambiando estado del artículo:', error);
            Swal.fire('Error', 'Error al cambiar estado del artículo', 'error');
        }
    }

    function verDetalleArticuloEvento(detalleId) {
        const articulo = articulosGestionActual.find(a => a.id_detalle === detalleId);
        if (!articulo) return;

        Swal.fire({
            title: articulo.nombre_articulo,
            html: `
                <div style="text-align: left;">
                    <p><strong>Código:</strong> ${articulo.codigo}</p>
                    <p><strong>Cantidad Solicitada:</strong> ${articulo.cantidad_solicitada}</p>
                    <p><strong>Cantidad Entregada:</strong> ${articulo.cantidad_entregada || 0}</p>
                    <p><strong>Cantidad Recogida:</strong> ${articulo.cantidad_recogida || 0}</p>
                    <p><strong>Cantidad Dañada:</strong> ${articulo.cantidad_dañada || 0}</p>
                    <p><strong>Cantidad Perdida:</strong> ${articulo.cantidad_perdida || 0}</p>
                    <p><strong>Estado:</strong> ${articulo.estado_articulo}</p>
                    <p><strong>Precio Unitario:</strong> Q${articulo.precio_unitario.toFixed(2)}</p>
                    ${articulo.notas ? `<p><strong>Notas:</strong> ${articulo.notas}</p>` : ''}
                </div>
            `,
            width: '600px',
            confirmButtonText: 'Cerrar'
        });
    }

    // ===============================================
    // CALENDARIO
    // ===============================================
    async function loadEventosDelMes(year, month) {
        try {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const fechaInicio = firstDay.toISOString().split('T')[0];
            const fechaFin = lastDay.toISOString().split('T')[0];
            
            const response = await fetch(`/api/eventos?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`);
            const data = await response.json();
            
            if (data.success) {
                eventosDelMes = data.eventos;
            } else {
                eventosDelMes = [];
            }
        } catch (error) {
            console.error('Error cargando eventos del mes:', error);
            eventosDelMes = [];
        }
    }

    async function generateCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        document.getElementById('mes-actual').textContent = `${monthNames[month]} ${year}`;
        
        const calendarGrid = document.getElementById('calendar-grid');
        const loadingDiv = document.getElementById('calendar-loading');
        loadingDiv.style.display = 'flex';
        calendarGrid.style.opacity = '0.5';
        
        await loadEventosDelMes(year, month);
        
        loadingDiv.style.display = 'none';
        calendarGrid.style.opacity = '1';
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        calendarGrid.innerHTML = '';
        
        const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
        dayHeaders.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            calendarGrid.appendChild(dayHeader);
        });
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        for (let i = 0; i < 42; i++) {
            const currentDay = new Date(startDate);
            currentDay.setDate(startDate.getDate() + i);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            if (currentDay.getMonth() !== month) {
                dayElement.classList.add('other-month');
            }
            
            const checkDate = new Date(currentDay);
            checkDate.setHours(0, 0, 0, 0);
            if (checkDate.getTime() === today.getTime()) {
                dayElement.classList.add('today');
            }
            
            const dayEvents = getEventosDelDia(currentDay);
            
            if (dayEvents.length > 0) {
                dayElement.classList.add('has-events');
            }
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = currentDay.getDate();
            dayElement.appendChild(dayNumber);
            
            if (dayEvents.length > 0) {
                const eventsContainer = document.createElement('div');
                eventsContainer.className = 'calendar-events';
                
                dayEvents.forEach(evento => {
                    const eventItem = document.createElement('div');
                    eventItem.className = `calendar-event-item estado-${evento.estado}`;
                    eventItem.onclick = (e) => {
                        e.stopPropagation();
                        verEventoDesdeCalendario(evento.id_evento);
                    };
                    
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'event-time';
                    timeSpan.textContent = evento.hora_inicio ? evento.hora_inicio.substring(0, 5) : '';
                    
                    const clientSpan = document.createElement('span');
                    clientSpan.className = 'event-client';
                    clientSpan.textContent = evento.cliente_nombre || 'Sin cliente';
                    
                    eventItem.appendChild(timeSpan);
                    eventItem.appendChild(clientSpan);
                    eventsContainer.appendChild(eventItem);
                });
                
                dayElement.appendChild(eventsContainer);
                
                if (dayEvents.length > 3) {
                    const countBadge = document.createElement('div');
                    countBadge.className = 'events-count';
                    countBadge.textContent = dayEvents.length;
                    dayElement.appendChild(countBadge);
                }
            }
            
            dayElement.onclick = () => selectDate(currentDay);
            
            calendarGrid.appendChild(dayElement);
        }
    }

    function getEventosDelDia(date) {
        const dateString = date.toISOString().split('T')[0];
        return eventosDelMes.filter(evento => {
            const eventoDate = evento.fecha_evento.split('T')[0];
            return eventoDate === dateString;
        });
    }

    function cambiarMes(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        generateCalendar();
    }

    function irAHoy() {
        currentDate = new Date();
        generateCalendar();
    }

    function selectDate(date) {
        selectedDate = date;
        
        const dayEvents = getEventosDelDia(date);
        
        if (dayEvents.length > 0) {
            mostrarEventosDelDia(date, dayEvents);
        } else {
            document.getElementById('evento-fecha').value = date.toISOString().split('T')[0];
            openModal('eventoModal');
        }
    }

    function mostrarEventosDelDia(date, eventos) {
        const dateString = date.toLocaleDateString('es-GT', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        const eventosHtml = eventos.map(evento => `
            <div class="evento-dia-item" style="padding: 1rem; border-left: 4px solid ${getColorEstado(evento.estado)}; background: #f8f9fa; border-radius: 8px; margin-bottom: 1rem; cursor: pointer;" onclick="verEventoDesdeCalendario(${evento.id_evento})">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">
                            ${evento.cliente_nombre || 'Sin cliente'}
                        </h4>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.875rem; color: var(--text-secondary);">
                            <span><i class="fas fa-clock"></i> ${evento.hora_inicio || '--:--'} - ${evento.hora_fin || '--:--'}</span>
                            ${evento.lugar_evento ? `<span><i class="fas fa-map-marker-alt"></i> ${evento.lugar_evento}</span>` : ''}
                            ${evento.numero_invitados ? `<span><i class="fas fa-users"></i> ${evento.numero_invitados} invitados</span>` : ''}
                        </div>
                    </div>
                    <span class="status-badge status-${evento.estado}">${evento.estado}</span>
                </div>
                ${evento.notas ? `<p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: var(--text-secondary);">${evento.notas}</p>` : ''}
            </div>
        `).join('');
        
        Swal.fire({
            title: `📅 Eventos del ${dateString}`,
            html: `
                <div style="text-align: left; max-height: 500px; overflow-y: auto;">
                    ${eventosHtml}
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="Swal.close(); document.getElementById('evento-fecha').value = '${date.toISOString().split('T')[0]}'; openModal('eventoModal');">
                        <i class="fas fa-plus"></i> Agregar evento este día
                    </button>
                </div>
            `,
            width: '800px',
            showConfirmButton: false,
            showCloseButton: true
        });
    }

    function getColorEstado(estado) {
        const colores = {
            'reservado': '#F59E0B',
            'confirmado': '#10B981',
            'completado': '#2563EB',
            'cancelado': '#EF4444',
            'pendiente_pago': '#3B82F6',  
            'en_preparacion': '#8B5CF6',
            'entregado': '#06B6D4'
        };
        return colores[estado] || '#6B7280';
    }

    async function verEventoDesdeCalendario(eventoId) {
        Swal.close();
        await verEvento(eventoId);
    }

    // ===============================================
    // PERFIL
    // ===============================================
    async function loadPerfilData() {
        try {
            const response = await fetch('/api/perfil');
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('perfil-nombre').value = data.perfil.nombre || '';
                document.getElementById('perfil-email').value = data.perfil.email || '';
                document.getElementById('perfil-telefono').value = data.perfil.telefono || '';
                document.getElementById('perfil-cargo').value = data.perfil.cargo || '';
                document.getElementById('perfil-direccion').value = data.perfil.direccion || '';
            }
        } catch (error) {
            console.error('Error loading perfil data:', error);
        }
    }

    // ===============================================
    // FORMULARIO DE REPORTES
    // ===============================================

    async function mostrarBotonEscribirProblema() {
        // Verificar si hay artículos con problemas
        const articulosConProblemas = articulosGestionActual.filter(a => a.estado_articulo === 'con_problemas');
        
        const footer = document.querySelector('#gestionArticulosEventoModal .modal-footer');
        
        // Limpiar botones anteriores
        const botonExistente = document.getElementById('btn-escribir-problemas');
        if (botonExistente) {
            botonExistente.remove();
        }
        
        if (articulosConProblemas.length > 0) {
            const boton = document.createElement('button');
            boton.id = 'btn-escribir-problemas';
            boton.className = 'btn btn-danger';
            boton.style.marginRight = 'auto';
            boton.innerHTML = '<i class="fas fa-exclamation-circle"></i> Escribe el problema';
            boton.onclick = () => abrirModalProblemasMultiples(eventoGestionActual.id_evento);
            
            footer.insertBefore(boton, footer.firstChild);
        }
    }

    async function abrirModalProblemasMultiples(eventoId) {
        try {
            Swal.fire({
                title: 'Cargando...',
                text: 'Obteniendo artículos con problemas',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const response = await fetch(`/api/eventos/${eventoId}/articulos-con-problemas`);
            const data = await response.json();
            
            if (data.success && data.articulos.length > 0) {
                document.getElementById('problemas-evento-id').value = eventoId;
                renderArticulosProblemas(data.articulos);
                Swal.close();
                openModal('reportarProblemasModal');
            } else {
                Swal.fire('Información', 'No hay artículos con problemas en este evento', 'info');
            }
            
        } catch (error) {
            console.error('Error cargando artículos con problemas:', error);
            Swal.fire('Error', 'Error al cargar artículos', 'error');
        }
    }


    function renderArticulosProblemas(articulos) {
    const container = document.getElementById('articulos-problemas-container');
    
    container.innerHTML = `
        <div class="table-container" style="background: white; border-radius: 12px; overflow: hidden;">
            <table class="table" style="margin: 0;">
                <thead>
                    <tr style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                        <th style="color: white;">Código</th>
                        <th style="color: white;">Artículo</th>
                        <th style="color: white;">Cantidad</th>
                        <th style="color: white;">Precio Unit.</th>
                        <th style="color: white;">Tipo Problema *</th>
                        <th style="color: white;">Responsable</th>
                        <th style="color: white;">Costo Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${articulos.map((articulo, index) => {
                        const costoTotal = (articulo.precio_unitario * articulo.cantidad).toFixed(2);
                        return `
                            <tr style="background: ${index % 2 === 0 ? '#FEF2F2' : '#FFFFFF'};">
                                <td style="font-weight: 600;">
                                    <code style="background: #DC2626; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">
                                        ${articulo.codigo}
                                    </code>
                                </td>
                                <td>
                                    <strong>${articulo.nombre_articulo}</strong>
                                    <input type="hidden" id="problema-detalle-${index}" value="${articulo.id_detalle}">
                                    <input type="hidden" id="problema-articulo-${index}" value="${articulo.id_articulo}">
                                    <input type="hidden" id="problema-precio-${index}" value="${articulo.precio_unitario}">
                                </td>
                                <td>
                                    <span style="background: #EF4444; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; display: inline-block;">
                                        ${articulo.cantidad}
                                    </span>
                                </td>
                                <td style="font-weight: 600; color: #059669;">
                                    Q${parseFloat(articulo.precio_unitario).toFixed(2)}
                                </td>
                                <td>
                                    <select class="form-control" id="problema-tipo-${index}" required 
                                            style="padding: 0.5rem; font-size: 0.9rem; border: 2px solid #DC2626;">
                                        <option value="">Seleccionar...</option>
                                        <option value="roto">Roto</option>
                                        <option value="perdido">Perdido</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="form-control" id="problema-responsable-${index}"
                                            style="padding: 0.5rem; font-size: 0.9rem;">
                                        <option value="Cliente">Cliente</option>
                                        <option value="Empresa">Empresa</option>
                                        <option value="Tercero">Tercero</option>
                                        <option value="Desconocido">Desconocido</option>
                                    </select>
                                </td>
                                <td style="font-weight: 700; color: #DC2626; font-size: 1.1rem;">
                                    Q${costoTotal}
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
                <tfoot>
                    <tr style="background: linear-gradient(135deg, #FEE2E2, #FECACA); border-top: 3px solid #DC2626;">
                        <td colspan="6" style="text-align: right; font-weight: 700; font-size: 1.1rem; padding: 1rem;">
                            COSTO TOTAL DE PROBLEMAS:
                        </td>
                        <td style="font-weight: 700; color: #DC2626; font-size: 1.3rem; padding: 1rem;">
                            Q${articulos.reduce((sum, a) => sum + (a.precio_unitario * a.cantidad), 0).toFixed(2)}
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div style="background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 1rem; border-radius: 8px; margin-top: 1.5rem;">
            <p style="margin: 0; color: #92400E; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> 
                <strong>Nota:</strong> Complete el tipo de problema y responsable para cada artículo. 
                Los costos se calculan automáticamente según el precio de alquiler.
            </p>
        </div>
    `;
}

   async function guardarProblemasMultiples() {
    const eventoId = document.getElementById('problemas-evento-id').value;
    const container = document.getElementById('articulos-problemas-container');
    const rows = container.querySelectorAll('tbody tr');
    
    const problemas = [];
    let errores = [];
    
    rows.forEach((row, index) => {
        const tipo = document.getElementById(`problema-tipo-${index}`)?.value;
        const responsable = document.getElementById(`problema-responsable-${index}`)?.value;
        const detalleId = document.getElementById(`problema-detalle-${index}`)?.value;
        const precio = document.getElementById(`problema-precio-${index}`)?.value;
        const articulo = articulosGestionActual.find(a => a.id_detalle == detalleId);
        
        if (!tipo) {
            errores.push(`Fila ${index + 1}: Tipo de problema requerido`);
            return;
        }
        
        // Generar descripción automática
        const tipoTexto = tipo === 'roto' ? 'Artículo roto' : 'Artículo perdido';
        const descripcion = `${tipoTexto} - ${articulo?.nombre_articulo || 'Artículo'} (Código: ${articulo?.codigo || 'N/A'})`;
        
        problemas.push({
            id_detalle: parseInt(detalleId),
            tipo_problema: tipo,
            descripcion_problema: descripcion,
            responsable: responsable,
            costo_problema: parseFloat(precio) * (articulo?.cantidad_solicitada || 1)
        });
    });
    
    if (errores.length > 0) {
        Swal.fire({
            icon: 'error',
            title: 'Campos incompletos',
            html: errores.join('<br>'),
            confirmButtonText: 'Entendido'
        });
        return;
    }
    
    if (problemas.length === 0) {
        Swal.fire('Error', 'No hay problemas para reportar', 'error');
        return;
    }
    
    try {
        Swal.fire({
            title: 'Guardando...',
            text: 'Creando reportes de problemas',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const response = await fetch(`/api/eventos/${eventoId}/reportar-problemas-multiples`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ problemas })
        });
        
        const data = await response.json();
        
        if (data.success) {
            closeModal('reportarProblemasModal');
            
            await Swal.fire({
                title: '✅ Reportes Creados',
                html: `
                    <div style="background: #F0FDF4; padding: 1.5rem; border-radius: 12px; border: 2px solid #10B981; margin-bottom: 1rem;">
                        <p style="font-size: 1.1rem; margin: 0; color: #065F46;">
                            <strong>${data.message}</strong>
                        </p>
                    </div>
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center;">
                        <button class="btn btn-danger" onclick="descargarReporteConsolidadoPDF(${eventoId})" 
                                style="padding: 1rem 2rem;">
                            <i class="fas fa-file-pdf"></i> Descargar PDF Consolidado
                        </button>
                        <button class="btn btn-secondary" onclick="Swal.close()" 
                                style="padding: 1rem 2rem;">
                            Cerrar
                        </button>
                    </div>
                `,
                icon: 'success',
                showConfirmButton: false,
                showCloseButton: true,
                width: '600px'
            });
            
            // Recargar la gestión de artículos
            await abrirGestionArticulosEvento(eventoId);
            
        } else {
            Swal.fire('Error', data.message, 'error');
        }
        
    } catch (error) {
        console.error('Error guardando problemas:', error);
        Swal.fire('Error', 'Error al guardar reportes', 'error');
    }
}
    function descargarReporteConsolidadoPDF(eventoId) {
        window.open(`/api/eventos/${eventoId}/reporte-problemas-consolidado/pdf`, '_blank');
        Swal.close();
    }


    // ===============================================
    // REPORTES
    // ===============================================
    function generarReporteEventos() {
        window.open('/api/reportes/eventos/pdf', '_blank');
    }

    function generarReporteInventario() {
        window.open('/api/reportes/inventario/pdf', '_blank');
    }

    function generarReporteProblemas() {
        window.open('/api/reportes/problemas/pdf', '_blank');
    }

    // ===============================================
    // MODALES
    // ===============================================
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
        
        if (modalId === 'eventoModal') {
            eventoCart = [];
            renderCart();
            
            document.getElementById('articulos-section').classList.add('hidden');
            document.getElementById('servicios-section').classList.add('hidden');
            document.getElementById('toggleArticulos').checked = false;
            document.getElementById('toggleServicios').checked = false;
            
            loadClientes();
            
            document.getElementById('evento-form').reset();
            document.querySelector('input[name="cliente-tipo"][value="existente"]').checked = true;
            toggleClienteForm('existente');
        }
        
        if (modalId === 'cotizacionModal') {
            cotizacionCart = [];
            renderCotizacionCart();
            
            document.getElementById('articulos-section-cot').classList.add('hidden');
            document.getElementById('servicios-section-cot').classList.add('hidden');
            document.getElementById('toggleArticulosCot').checked = false;
            document.getElementById('toggleServiciosCot').checked = false;
            
            loadClientes();
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        
        const form = document.querySelector(`#${modalId} form`);
        if (form) {
            form.reset();
        }
    }

    window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }

    // ===============================================
    // UTILIDADES
    // ===============================================
    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('es-GT');
    }

    function formatDateTimeFull(dateTimeString) {
        if (!dateTimeString) return 'N/A';
        
        try {
            const date = new Date(dateTimeString);
            
            if (isNaN(date.getTime())) {
                return 'Fecha inválida';
            }
            
            return date.toLocaleString('es-GT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true,
                timeZone: 'America/Guatemala'  
            });
        } catch (error) {
            console.error('Error formateando fecha:', error);
            return 'Error en fecha';
        }
    }

    function formatCurrency(amount) {
        return `Q${parseFloat(amount || 0).toFixed(2)}`;
    }

    // ===============================================
    // EVENT LISTENERS - BÚSQUEDA
    // ===============================================
    document.getElementById('search-clientes')?.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const filteredClientes = clientes.filter(cliente => 
            cliente.nombre.toLowerCase().includes(searchTerm) ||
            (cliente.telefono && cliente.telefono.toLowerCase().includes(searchTerm))
        );
        renderClientesTable(filteredClientes);
    });

    document.getElementById('search-eventos')?.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const filteredEventos = eventos.filter(evento => 
            evento.cliente_nombre.toLowerCase().includes(searchTerm) ||
            (evento.lugar_evento && evento.lugar_evento.toLowerCase().includes(searchTerm))
        );
        renderEventosTable(filteredEventos);
    });

    document.getElementById('search-articulos-evento')?.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = articulosDisponibles.filter(articulo => 
            articulo.nombre_articulo.toLowerCase().includes(searchTerm) ||
            articulo.codigo.toLowerCase().includes(searchTerm)
        );
        
        const grid = document.getElementById('articulos-grid');
        grid.innerHTML = filtered.map(articulo => `
            <div class="item-card" onclick="addItemToCart('articulo', ${articulo.id_articulo})">
                <h5>${articulo.nombre_articulo}</h5>
                <div class="price">Q${parseFloat(articulo.precio_unitario).toFixed(2)}</div>
                <div class="stock">Stock: ${articulo.cantidad_disponible}</div>
            </div>
        `).join('');
    });

    // Búsqueda y filtros de cotizaciones
    document.getElementById('search-cotizaciones')?.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        aplicarFiltrosCotizaciones();
    });

    document.getElementById('filter-estado-cotizacion')?.addEventListener('change', function(e) {
        aplicarFiltrosCotizaciones();
    });

    async function aplicarFiltrosCotizaciones() {
        const searchTerm = document.getElementById('search-cotizaciones').value.toLowerCase();
        const estadoFiltro = document.getElementById('filter-estado-cotizacion').value;
        
        try {
            const response = await fetch('/api/cotizaciones');
            const data = await response.json();
            
            if (data.success) {
                let filteredCotizaciones = data.cotizaciones;
                
                // Filtro por estado
                if (estadoFiltro) {
                    filteredCotizaciones = filteredCotizaciones.filter(c => c.estado === estadoFiltro);
                }
                
                // Filtro por búsqueda
                if (searchTerm) {
                    filteredCotizaciones = filteredCotizaciones.filter(c => 
                        (c.numero_cotizacion && c.numero_cotizacion.toLowerCase().includes(searchTerm)) ||
                        (c.cliente_nombre && c.cliente_nombre.toLowerCase().includes(searchTerm)) ||
                        (c.lugar_evento && c.lugar_evento.toLowerCase().includes(searchTerm))
                    );
                }
                
                renderCotizacionesTable(filteredCotizaciones);
            }
        } catch (error) {
            console.error('Error aplicando filtros:', error);
        }
    }


    // ===============================================
    // REPORTES FUNCIONES
    // ===============================================

    // Abrir modal de configuración de reporte
    function abrirConfiguracionReporte(tipo) {
        switch(tipo) {
            case 'eventos':
                loadClientesParaReporte();
                setFechasDefault('eventos');
                cargarPreviewEventos();
                openModal('configEventosModal');
                break;
            case 'inventario':
                cargarPreviewInventario();
                openModal('configInventarioModal');
                break;
            case 'problemas':
                setFechasDefault('problemas');
                cargarPreviewProblemas();
                openModal('configProblemasModal');
                break;
        }
    }

    // Cargar clientes para el filtro de reportes
    async function loadClientesParaReporte() {
        if (clientes.length === 0) {
            await loadClientes();
        }
        const select = document.getElementById('config-eventos-cliente');
        select.innerHTML = '<option value="">Todos los clientes</option>' +
            clientes.map(c => `<option value="${c.id_cliente}">${c.nombre}</option>`).join('');
    }

    // Establecer fechas por defecto
    function setFechasDefault(tipo) {
        const hoy = new Date();
        const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        
        if (tipo === 'eventos') {
            document.getElementById('config-eventos-fecha-inicio').value = inicioMes.toISOString().split('T')[0];
            document.getElementById('config-eventos-fecha-fin').value = hoy.toISOString().split('T')[0];
        } else if (tipo === 'problemas') {
            document.getElementById('config-problemas-fecha-inicio').value = inicioMes.toISOString().split('T')[0];
            document.getElementById('config-problemas-fecha-fin').value = hoy.toISOString().split('T')[0];
        }
    }

    // Establecer período rápido
    function setPeriodoRapido(periodo, tipo) {
        // Remover clase active de todos los botones
        const modal = tipo === 'eventos' ? 'configEventosModal' : 'configProblemasModal';
        document.querySelectorAll(`#${modal} .periodo-btn`).forEach(btn => btn.classList.remove('active'));
        
        const hoy = new Date();
        let fechaInicio, fechaFin = hoy;
        
        switch(periodo) {
            case 'hoy':
                fechaInicio = hoy;
                break;
            case 'semana':
                fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate() - 7);
                break;
            case 'mes':
                fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                break;
            case 'trimestre':
                fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth() - 3, 1);
                break;
            case 'anio':
                fechaInicio = new Date(hoy.getFullYear(), 0, 1);
                break;
            case 'personalizado':
                event.target.classList.add('active');
                document.getElementById(`fechas-personalizadas-${tipo}`).style.display = 'grid';
                return;
        }
        
        event.target.classList.add('active');
        document.getElementById(`fechas-personalizadas-${tipo}`).style.display = 'none';
        
        if (tipo === 'eventos') {
            document.getElementById('config-eventos-fecha-inicio').value = fechaInicio.toISOString().split('T')[0];
            document.getElementById('config-eventos-fecha-fin').value = fechaFin.toISOString().split('T')[0];
            cargarPreviewEventos();
        } else if (tipo === 'problemas') {
            document.getElementById('config-problemas-fecha-inicio').value = fechaInicio.toISOString().split('T')[0];
            document.getElementById('config-problemas-fecha-fin').value = fechaFin.toISOString().split('T')[0];
            cargarPreviewProblemas();
        }
    }

    // Cargar preview de eventos
    async function cargarPreviewEventos() {
        try {
            const fechaInicio = document.getElementById('config-eventos-fecha-inicio').value;
            const fechaFin = document.getElementById('config-eventos-fecha-fin').value;
            const estado = document.getElementById('config-eventos-estado').value;
            
            let url = `/api/eventos?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
            if (estado) url += `&estado=${estado}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success) {
                const eventos = data.eventos;
                const totalEventos = eventos.length;
                const totalIngresos = eventos.reduce((sum, e) => sum + parseFloat(e.monto_total || 0), 0);
                const totalPagado = eventos.reduce((sum, e) => sum + parseFloat(e.monto_pagado || 0), 0);
                const totalPendiente = totalIngresos - totalPagado;
                
                document.querySelector('#preview-eventos-stats .preview-stat:nth-child(1) .preview-stat-number').textContent = totalEventos;
                document.querySelector('#preview-eventos-stats .preview-stat:nth-child(2) .preview-stat-number').textContent = `Q${totalIngresos.toFixed(2)}`;
                document.querySelector('#preview-eventos-stats .preview-stat:nth-child(3) .preview-stat-number').textContent = `Q${totalPagado.toFixed(2)}`;
                document.querySelector('#preview-eventos-stats .preview-stat:nth-child(4) .preview-stat-number').textContent = `Q${totalPendiente.toFixed(2)}`;
            }
        } catch (error) {
            console.error('Error cargando preview:', error);
        }
    }

    // Cargar preview de inventario
    async function cargarPreviewInventario() {
        try {
            const response = await fetch('/api/articulos');
            const data = await response.json();
            
            if (data.success) {
                const articulos = data.articulos;
                const totalArticulos = articulos.length;
                const stockTotal = articulos.reduce((sum, a) => sum + (a.cantidad_total || 0), 0);
                const stockDisponible = articulos.reduce((sum, a) => sum + (a.cantidad_disponible || 0), 0);
                const valorTotal = articulos.reduce((sum, a) => sum + (parseFloat(a.precio_unitario || 0) * (a.cantidad_total || 0)), 0);
                
                document.querySelector('#preview-inventario-stats .preview-stat:nth-child(1) .preview-stat-number').textContent = totalArticulos;
                document.querySelector('#preview-inventario-stats .preview-stat:nth-child(2) .preview-stat-number').textContent = stockTotal;
                document.querySelector('#preview-inventario-stats .preview-stat:nth-child(3) .preview-stat-number').textContent = stockDisponible;
                document.querySelector('#preview-inventario-stats .preview-stat:nth-child(4) .preview-stat-number').textContent = `Q${valorTotal.toFixed(2)}`;
            }
        } catch (error) {
            console.error('Error cargando preview inventario:', error);
        }
    }

    // Cargar preview de problemas
    async function cargarPreviewProblemas() {
        try {
            const fechaInicio = document.getElementById('config-problemas-fecha-inicio').value;
            const fechaFin = document.getElementById('config-problemas-fecha-fin').value;
            
            // Aquí necesitarías un endpoint específico para problemas con filtros
            // Por ahora, mostramos datos de ejemplo
            
            document.querySelector('#preview-problemas-stats .preview-stat:nth-child(1) .preview-stat-number').textContent = '-';
            document.querySelector('#preview-problemas-stats .preview-stat:nth-child(2) .preview-stat-number').textContent = '-';
            document.querySelector('#preview-problemas-stats .preview-stat:nth-child(3) .preview-stat-number').textContent = '-';
            document.querySelector('#preview-problemas-stats .preview-stat:nth-child(4) .preview-stat-number').textContent = '-';
            
        } catch (error) {
            console.error('Error cargando preview problemas:', error);
        }
    }

    // Generar reporte de eventos con configuración
    function generarReporteEventosConfig() {
        const fechaInicio = document.getElementById('config-eventos-fecha-inicio').value;
        const fechaFin = document.getElementById('config-eventos-fecha-fin').value;
        const estado = document.getElementById('config-eventos-estado').value;
        const clienteId = document.getElementById('config-eventos-cliente').value;
        const detallado = document.getElementById('config-eventos-detallado').checked;
        
        let url = `/api/reportes/eventos/pdf?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
        if (estado) url += `&estado=${estado}`;
        if (clienteId) url += `&cliente_id=${clienteId}`;
        if (detallado) url += `&detallado=true`;
        
        window.open(url, '_blank');
        closeModal('configEventosModal');
        
        Swal.fire({
            icon: 'success',
            title: 'Reporte Generado',
            text: 'El reporte se está descargando',
            timer: 2000,
            showConfirmButton: false
        });
    }

    // Generar reporte de inventario con configuración
    function generarReporteInventarioConfig() {
        const categoria = document.getElementById('config-inventario-categoria').value;
        const stockBajo = document.getElementById('config-inventario-stock-bajo').checked;
        const valorizacion = document.getElementById('config-inventario-valorizacion').checked;
        const daniados = document.getElementById('config-inventario-daniados').checked;
        
        let url = `/api/reportes/inventario/pdf?`;
        if (categoria) url += `categoria=${categoria}&`;
        if (stockBajo) url += `stock_bajo=true&`;
        if (valorizacion) url += `valorizacion=true&`;
        if (daniados) url += `daniados=true&`;
        
        window.open(url, '_blank');
        closeModal('configInventarioModal');
        
        Swal.fire({
            icon: 'success',
            title: 'Reporte Generado',
            text: 'El reporte se está descargando',
            timer: 2000,
            showConfirmButton: false
        });
    }

    // Generar reporte de problemas con configuración
    function generarReporteProblemasConfig() {
        const fechaInicio = document.getElementById('config-problemas-fecha-inicio').value;
        const fechaFin = document.getElementById('config-problemas-fecha-fin').value;
        const tipo = document.getElementById('config-problemas-tipo').value;
        const responsable = document.getElementById('config-problemas-responsable').value;
        const graficos = document.getElementById('config-problemas-graficos').checked;
        
        let url = `/api/reportes/problemas/pdf?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
        if (tipo) url += `&tipo=${tipo}`;
        if (responsable) url += `&responsable=${responsable}`;
        if (graficos) url += `&graficos=true`;
        
        window.open(url, '_blank');
        closeModal('configProblemasModal');
        
        Swal.fire({
            icon: 'success',
            title: 'Reporte Generado',
            text: 'El reporte se está descargando',
            timer: 2000,
            showConfirmButton: false
        });
    }

    // Cargar estadísticas de reportes cuando se abre la sección
    async function loadReportesStats() {
        try {
            // Total eventos este mes
            const hoy = new Date();
            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            const response = await fetch(`/api/eventos?fecha_inicio=${inicioMes.toISOString().split('T')[0]}&fecha_fin=${hoy.toISOString().split('T')[0]}`);
            const dataEventos = await response.json();
            
            if (dataEventos.success) {
                document.getElementById('total-eventos-mes').textContent = dataEventos.eventos.length;
            }
            
            // Valor inventario
            const responseArticulos = await fetch('/api/articulos');
            const dataArticulos = await responseArticulos.json();
            
            if (dataArticulos.success) {
                const valorTotal = dataArticulos.articulos.reduce((sum, a) => 
                    sum + (parseFloat(a.precio_unitario || 0) * (a.cantidad_total || 0)), 0
                );
                document.getElementById('valor-inventario').textContent = `Q${valorTotal.toFixed(2)}`;
            }
            
            // Problemas este mes - Por ahora dejamos en 0
            document.getElementById('reportes-problemas-mes').textContent = '0';
            
        } catch (error) {
            console.error('Error cargando stats de reportes:', error);
        }
    }

    // Actualizar la función loadSectionData para incluir reportes
    const originalLoadSectionData = loadSectionData;
    loadSectionData = function(sectionId) {
        originalLoadSectionData(sectionId);
        if (sectionId === 'reportes') {
            loadReportesStats();
        }
    }
    </script>
</body>
</html>